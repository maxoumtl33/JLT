{% extends 'listings/base.html' %}
{% load custom_filters %}
{% block content %}
<style>
    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        color: #333;
        display: flex;
        height: 100vh;
        overflow: hidden;
        transition: background-color 0.3s linear, color 0.3s linear;
    }

    .sidebar {
        width: 250px;
        background-color: #007BFF;
        height: 100%;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        overflow-y: auto;
    }

    .sidebar .sidebar-header {
        font-size: 24px;
        color: #fff;
        margin-bottom: 20px;
    }

    .sidebar a {
        color: #fff;
        display: block;
        padding: 10px;
        text-decoration: none;
        margin-bottom: 10px;
        border-radius: 8px;
        transition: background-color 0.3s;
    }

    .sidebar a.active, .sidebar a:hover {
        background-color: #0056b3;
    }

    .stats {
        flex: 1;
        padding: 20px;
        background-color: #F0F2F5;
        overflow-y: auto;
        transition: margin-left 0.3s ease;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .header .toggle-theme {
        cursor: pointer;
        color: #007BFF;
    }

    #stats.expanded {
        margin-left: 0;
    }

    #stats.full-width {
        transition: margin-left 0s;
    }

    .collapsed {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        width: 0;
    }

    .dark-mode {
        background-color: #121212;
        color: #e4e4e4;
    }

    .dark-mode .header, .dark-mode .card {
        background-color: #1e1e1e;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .dark-mode .sidebar {
        background-color: #1e1e1e;
    }

    .dark-mode .sidebar a {
        color: #e4e4e4;
    }

    .dark-mode .sidebar a.active, .dark-mode .sidebar a:hover {
        background-color: #333;
        color: #fff;
    }

    .date-filters-container {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .date-filter-group {
        margin-bottom: 15px;
    }

    .submission-type-toggle {
        display: flex;
        align-items: center;
        margin-top: 10px;
    }

    .submission-type-toggle label {
        margin-right: 15px;
        cursor: pointer;
    }

    .filter-divider {
        border-top: 2px solid #dee2e6;
        margin: 20px 0;
    }
</style>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header" style="margin-top: 100px;">
        Menu <button class="toggle-sidebar" id="sidebar-toggle"><i class="fas fa-bars"></i></button>
    </div>
    <a href="{% url 'conseiller_dashboard' %}" class="aref"><i class="fa-solid fa-desktop me-2"></i> Tableau de bord</a>
    <a href="{% url 'journees-list' %}" class="aref"><i class="fa-solid fa-truck me-2"></i> Livraisons</a>
    <a href="{% url 'creerchecklist' %}" class="aref"><i class="fas fa-list-check me-2"></i> Checklists</a>    
    <a href="{% url 'calendarsub_view' %}"><i class="fa-solid fa-file-contract me-2"></i>Soumissions</a>
    <a href="{% url 'submit_request' %}" target="_blank" class="aref"><i class="fa-solid fa-file-signature me-2"></i>Cr√©er Soumission</a>
    <a class="aref" href="{% url 'etiquette-tente' %}"><i class="fa-solid fa-print me-2"></i>Etiquette tente</a>
  
    {% if user.username == "Audrey" or user.username == "Maxime" or user.username == "Roxanne" %}
        <a href="{% url 'calendarsubcreate_view' %}" class="aref">
            <i class="fa-solid fa-calendar-days me-2"></i>Suivi Soumissions
        </a>
    {% endif %}
    
    <button class="toggle-theme" id="theme-toggle" style="margin-top:10px;"><i class="fas fa-moon"></i> Th√®me</button>
    <div style="margin-top:20px; font-size:14px; color:#ccc;">Utilisateur: {{ user.username }}</div>
</div>

<div class="stats" id="stats">
    <div class="header">
        <h2>Statistique des Soumissions et Commandes</h2>
        <button id="show-sidebar" style="display:none; position: fixed; top: 12%; left: 10px;">
            <i class="fas fa-bars fa-2xl"></i>
        </button>
        <div class="user-info">
            <button id="logoutBtn" style="border:none; background:none; cursor:pointer;">
                <i class="fas fa-sign-out-alt"></i> D√©connexion
            </button>
        </div>
    </div>
    <br><br><br><br>

    <!-- Filter Section -->
    <div class="container my-4">
        <form method="GET" action="{% url 'manage_submissions' %}" class="row g-3" id="filterForm">
            
            <!-- Premi√®re ligne de filtres -->
            <div class="col-md-4">
                <label for="conseiller" class="form-label fw-bold">Conseiller:</label>
                <select name="conseiller" id="conseiller" class="form-select">
                    <option value="">Tous les conseillers</option>
                    {% for conseiller in conseillers %}
                        <option value="{{ conseiller.id }}" {% if conseiller.id|stringformat:"s" == selected_conseiller %}selected{% endif %}>
                            {{ conseiller.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
      
            <div class="col-md-4">
                <label for="submission_type" class="form-label fw-bold">Type de Soumission:</label>
                <select name="submission_type" id="submission_type" class="form-select">
                    <option value="">Tous</option>
                    <option value="Soumission √©v√©nement" {% if submission_type == "Soumission √©v√©nement" %}selected{% endif %}>Soumission √©v√©nement</option>
                    <option value="Commande √©v√©nement" {% if submission_type == "Commande √©v√©nement" %}selected{% endif %}>Commande √©v√©nement</option>
                    <option value="Soumission BAL/Buffet" {% if submission_type == "Soumission BAL/Buffet" %}selected{% endif %}>Soumission BAL/Buffet</option>
                    <option value="Commande BAL/Buffet" {% if submission_type == "Commande BAL/Buffet" %}selected{% endif %}>Commande BAL/Buffet</option>
                </select>
            </div>
      
            <div class="col-md-4">
                <label for="status" class="form-label fw-bold">Statut:</label>
                <select name="status" id="status" class="form-select">
                    <option value="">Tous les statuts</option>
                    <option value="valide" {% if status_filter == "valide" %}selected{% endif %}>Valid√©</option>
                    <option value="refuse" {% if status_filter == "refuse" %}selected{% endif %}>Refus√©</option>
                    <option value="en_cours" {% if status_filter == "en_cours" %}selected{% endif %}>En cours</option>
                    <option value="envoy√©" {% if status_filter == "envoy√©" %}selected{% endif %}>Envoy√©</option>
                </select>
            </div>

            <!-- Section des filtres de date -->
            <div class="col-12 date-filters-container">
                <h5 class="mb-3"><i class="fas fa-calendar-alt"></i> Filtres de date</h5>
                
                <!-- Filtres pour Date de cr√©ation -->
                <div class="date-filter-group">
                    <label class="form-label fw-bold text-primary">üìÖ Date de cr√©ation:</label>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="creation_start_date" class="form-label">Du:</label>
                            <input type="date" id="creation_start_date" name="creation_start_date" 
                                   class="form-control" value="{{ creation_start_date }}" />
                        </div>
                        <div class="col-md-6">
                            <label for="creation_end_date" class="form-label">Au:</label>
                            <input type="date" id="creation_end_date" name="creation_end_date" 
                                   class="form-control" value="{{ creation_end_date }}" />
                        </div>
                    </div>
                </div>

                <hr class="filter-divider">

                <!-- Filtres pour Date d'√©v√©nement -->
                <div class="date-filter-group">
                    <label class="form-label fw-bold text-success">üéâ Date d'√©v√©nement:</label>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="event_start_date" class="form-label">Du:</label>
                            <input type="date" id="event_start_date" name="event_start_date" 
                                   class="form-control" value="{{ event_start_date }}" />
                        </div>
                        <div class="col-md-6">
                            <label for="event_end_date" class="form-label">Au:</label>
                            <input type="date" id="event_end_date" name="event_end_date" 
                                   class="form-control" value="{{ event_end_date }}" />
                        </div>
                    </div>
                </div>
            </div>

     
      
            <!-- Boutons -->
            <div class="col-12 d-flex gap-3 mt-4">
                <button type="submit" class="btn btn-primary flex-fill">
                    <i class="fas fa-filter"></i> Filtrer
                </button>
                <a href="{% url 'manage_submissions' %}" class="btn btn-outline-secondary flex-fill">
                    <i class="fas fa-undo"></i> R√©initialiser
                </a>
            </div>
        </form>
    </div>

    <!-- Display Submission Count -->
    <div class="mb-4">
        <p class="text-center">Total des soumissions filtr√©es: <strong>{{ submission_count }}</strong></p>
    </div>
    
    <div class="mb-4 text-center">
        <button onclick="generatePDF()" class="btn btn-secondary">
            T√©l√©charger Soumissions en PDF <i class="fa-solid fa-file-pdf"></i>
        </button>
        <br><br>

        <form method="GET" action="{% url 'manage_submissions' %}" class="mb-3">
            <div class="input-group mb-3" style="max-width: 400px; margin: 0 auto;">
                <input type="text" name="search" class="form-control" 
                       placeholder="Rechercher une soumission" 
                       value="{{ request.GET.search }}">
                <button class="btn btn-outline-secondary" type="submit">Rechercher</button>
            </div>
        </form>
    </div>

    <table class="table table-striped" id="submissionsTable">
        <thead>
            <tr>
                <th>Client</th>
                <th>Type</th>
                <th>Utilisateur</th>
                <th>Cr√©√© √†</th>
                <th>Date √©v√©nement</th>
                <th>Status</th>
                <th>D√©tails</th>
            </tr>
        </thead>
        <tbody>
            {% for submission in submissions %}
                <tr>
                    <td>{{ submission.company_name }}</td>
                    <td>{{ submission.get_submission_type_display|default:submission.submission_type }}</td>
                    <td>{{ submission.user.username }}</td>
                    <td>{{ submission.created_at|date:"d/m/Y H:i" }}</td>
                    <td>{{ submission.date|date:"d/m/Y"|default:"N/A" }}</td>
                    <td>
                        {% if submission.status == "valide" %}
                            <span class="badge bg-success"><i class="fa-solid fa-check-circle me-1"></i>Valid√©</span>
                        {% elif submission.status == "refuse" %}
                            <span class="badge bg-danger"><i class="fa-solid fa-times-circle me-1"></i>Refus√©</span>
                        {% elif submission.status == "en_cours" %}
                            <span class="badge bg-warning"><i class="fa-solid fa-spinner me-1"></i>En cours</span>
                        {% elif submission.status == "envoy√©" %}
                            <span class="badge bg-primary"><i class="fa-solid fa-paper-plane me-1"></i>Envoy√©</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'submission_detail' submission.id %}" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7" class="text-center">Aucune soumission trouv√©e.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination justify-content-center my-4">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if submissions.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ submissions.previous_page_number }}&{{ request.GET.urlencode }}" 
                           aria-label="Pr√©c√©dente">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% endif %}
        
                <li class="page-item disabled">
                    <span class="page-link">
                        Page {{ submissions.number }} sur {{ submissions.paginator.num_pages }}
                    </span>
                </li>
        
                {% if submissions.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ submissions.next_page_number }}&{{ request.GET.urlencode }}" 
                           aria-label="Suivant">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ submissions.paginator.num_pages }}&{{ request.GET.urlencode }}" 
                           aria-label="Derni√®re">
                            Derni√®re
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Fonction pour g√©n√©rer le PDF
function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('landscape');

    pdf.setFontSize(16);
    pdf.text('Rapport des Soumissions', 14, 15);
    
    pdf.setFontSize(12);
    const submissionCount = "{{ submission_count }}";
    
    pdf.text(`Total des soumissions: ${submissionCount}`, 14, 25);
    
    let yPosition = 35;

    // Fonction pour ajuster l'heure (-4h)
    function adjustTime(dateStr) {
        if (!dateStr || dateStr === 'N/A' || dateStr === 'Non envoy√©') return dateStr;
        
        const parts = dateStr.split(' ');
        if (parts.length !== 2) return dateStr;
        
        const dateParts = parts[0].split('/');
        const timeParts = parts[1].split(':');
        
        if (dateParts.length !== 3 || timeParts.length !== 2) return dateStr;
        
        const date = new Date(
            parseInt(dateParts[2]),
            parseInt(dateParts[1]) - 1,
            parseInt(dateParts[0]),
            parseInt(timeParts[0]),
            parseInt(timeParts[1])
        );
        
        date.setHours(date.getHours() - 4);
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    const submissionsData = [];
    
    {% for submission in submissions %}
        let sentAtValue;
        {% if submission.sent_at %}
            sentAtValue = adjustTime('{{ submission.sent_at|date:"d/m/Y H:i" }}');
        {% elif submission.status == "envoy√©" %}
            sentAtValue = adjustTime('{{ submission.created_at|date:"d/m/Y H:i" }}');
        {% else %}
            sentAtValue = 'Non envoy√©';
        {% endif %}
        
        submissionsData.push([
            '{{ submission.company_name|escapejs }}',
            '{{ submission.guest_count|default:"N/A" }}',
            '{{ submission.user.username|escapejs }}',
            '{{ submission.created_at|date:"d/m/Y H:i" }}',
            '{{ submission.status|capfirst }}',
            '{{ submission.date|date:"d/m/Y"|default:"N/A" }}',
            sentAtValue
        ]);
    {% endfor %}

    pdf.autoTable({
        head: [['Nom √©v√©nement', 'Nb personnes', 'Utilisateur', 'Cr√©ation', 'Statut', 'Date √©v√©nement', 'Envoy√© quand']],
        body: submissionsData,
        startY: yPosition,
        theme: 'grid',
        styles: {
            fontSize: 9,
            cellPadding: 2,
            overflow: 'linebreak'
        },
        headStyles: {
            fillColor: [0, 123, 255],
            textColor: 255,
            fontStyle: 'bold'
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245]
        },
        columnStyles: {
            0: { cellWidth: 50 },
            1: { cellWidth: 25, halign: 'center' },
            2: { cellWidth: 30 },
            3: { cellWidth: 35 },
            4: { cellWidth: 25, halign: 'center' },
            5: { cellWidth: 30 },
            6: { cellWidth: 35 }
        }
    });

    const pageCount = pdf.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        pdf.setPage(i);
        pdf.setFontSize(8);
        pdf.text(
            `G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`,
            14,
            pdf.internal.pageSize.height - 10
        );
        pdf.text(
            `Page ${i} sur ${pageCount}`,
            pdf.internal.pageSize.width - 30,
            pdf.internal.pageSize.height - 10
        );
    }

    const today = new Date().toISOString().split('T')[0];
    const userName = "{{ user.username|default:'' }}".replace(/\s+/g, '_');
    pdf.save(`soumissions_${userName}_${today}.pdf`);
}

// Theme toggle
const toggleBtn = document.getElementById('theme-toggle');
toggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
});

// Sidebar toggle
document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const btnShowSidebar = document.getElementById('show-sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    const stats = document.getElementById('stats');

    toggleBtn.addEventListener('click', () => {
        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            btnShowSidebar.style.display = 'none';
            stats.classList.remove('full-width');
        } else {
            sidebar.classList.add('collapsed');
            btnShowSidebar.style.display = 'block';
            stats.classList.add('full-width');
        }
    });

    btnShowSidebar.addEventListener('click', () => {
        sidebar.classList.remove('collapsed');
        btnShowSidebar.style.display = 'none';
        stats.classList.remove('full-width');
    });
});
</script>

{% endblock %}