{% extends 'listings/base.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}

<!-- Inclure Bootstrap 5 (pas Bootstrap 4) pour une design moderne -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  /* Style global simplifié et modernisé */
  .content-container {
    margin-top: 30px;
    background: #f8f9fa;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  }
  h1, h3 {
    color: #222;
  }
  /* Z-index pour select2 dropdown (si besoin) */
  .select2-container--open {
    z-index: 1050;
  }
  /* Bouton retour stylé avec icon moderne */
  .back-link {
    color: #0d6efd;
    font-weight: 600;
    display: flex;
    align-items: center;
    text-decoration: none;
    font-size: 1.1rem;
  }
  .back-link i {
    margin-right: 8px;
  }
  /* Carte checklist style amélioré */
  .card {
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
  }
  /* Boutons swipe améliorés */
  .swipe-btn {
    min-width: 40px;
    padding: 6px 10px;
    font-size: 1.1rem;
    border-radius: 50%;
  }
  /* Responsiveness */
  @media(max-width: 768px){
    .table-responsive { display: none; }
    .checklist-card {
      padding: 15px;
      margin-bottom: 15px;
    }
  }
  /* Alerts custom */
  .alert {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
  }
</style>

{% if messages %}
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999; max-width: 350px;">
    {% for message in messages %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="container content-container">

  <!-- Bouton retour stylisé -->
  <a href="{% url 'voir_checklist' %}" class="back-link mb-3">
    <i class="fas fa-arrow-left"></i> Retour
  </a>

  <h1 class="mb-4">Checklist : {{ checklist.name }}</h1>
  <div class="mt-5">
    <h3>Produits dans la checklist</h3>
    <br>
    <div class="row g-3 mb-4">
      {% for checklist_product in all_items %}
        <div class="col-lg-4 col-md-6 col-sm-12">
          <div class="card shadow-sm h-100" style="background-color: {% if checklist_product.status == 'en_cours' %}#ffe0b2{% elif checklist_product.status == 'valide' %}#c8e6c9{% elif checklist_product.status == 'refuse' %}#ef9a9a{% elif checklist_product.status == 'complete' %}#c8e6c9{% elif checklist_product.status == 'pending' %}#ffe0b2{% elif checklist_product.status == 'denied' %}#ef9a9a{% endif %}; border-radius:10px; transition: transform 0.2s;">
            <div class="card-body position-relative d-flex flex-column justify-content-between">
              <!-- Bouton modif -->
              <button type="button" class="btn btn-outline-primary btn-sm position-absolute top-2 end-2 edit-item" data-id="{{ checklist_product.id }}" data-product="{{ checklist_product.product.id }}" data-quantity="{{ checklist_product.quantity }}" title="Modifier produit" style="z-index: 10;">
                <i class="fa fa-pencil-alt"></i>
              </button>
              
              <h5 class="card-title text-center mt-3">{{ checklist_product.product.name }}</h5>
              <p class="text-center mb-0">Quantité : {{ checklist_product.quantity }}</p>
              <p class="text-center text-muted" style="font-size: 0.9rem;">{{ checklist_product.commentaire }}</p>

              <!-- Form avec actions simplifiées -->
              <form method="post" action="{% url 'checklistvoir-detail' checklist.id %}" class="mt-3" id="status-form-{{ checklist_product.id }}">
                {% csrf_token %}
                <input type="hidden" name="item_id" value="{{ checklist_product.id }}">
                <input type="hidden" name="status" id="status_{{ checklist_product.id }}" value="">

                <!-- Boutons simplifiés - seulement Valider et Refuser -->
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                  <button type="button" class="btn btn-outline-success swipe-btn" 
                          onclick="submitStatusForm('{{ checklist_product.id }}', 'valide')"
                          title="Valider">
                          <i class="fa-solid fa-check"></i>
                  </button>

                  <button type="button" class="btn btn-outline-danger swipe-btn" 
                          onclick="submitStatusForm('{{ checklist_product.id }}', 'refuse')"
                          title="Refuser">
                          <i class="fa-solid fa-ban"></i>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Détails checklist dans une card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <dl class="row mb-0">
        <dt class="col-sm-3">Date événement :</dt>
        <dd class="col-sm-9">{{ checklist.date|date:"d/m/Y" }}</dd>

        <dt class="col-sm-3">Lieu événement :</dt>
        <dd class="col-sm-9">{{ checklist.lieu }}</dd>

        <dt class="col-sm-3">Nombre convives :</dt>
        <dd class="col-sm-9">{{ checklist.nb_convive }}</dd>

        <dt class="col-sm-3">Heure de livraison :</dt>
        <dd class="col-sm-9">{{ checklist.heure_livraison }}</dd>

        <dt class="col-sm-3">Numéro de contrat :</dt>
        <dd class="col-sm-9">{{ checklist.num_contrat }}</dd>

        <dt class="col-sm-3">Conseiller :</dt>
        <dd class="col-sm-9">{{ checklist.conseillere }}</dd>

        <dt class="col-sm-3">Nom du MD :</dt>
        <dd class="col-sm-9">{{ checklist.md }}</dd>
      </dl>
    </div>
  </div>

  <!-- Bouton impression stylisé -->
  <div class="mb-4 text-end">
    <button class="btn btn-primary" onclick="printChecklist()">
      <i class="fas fa-print"></i> Imprimer la checklist
    </button>
  </div>

  <!-- Section cachée pour impression -->
  <div id="print-section" style="display:none;">
    {% if checklist.is_active %}
      <div class="page" data-checklist-date="{{ checklist.date|date:'Y-m-d' }}">
        <h2>{{ checklist.name }}</h2>
        <p><strong>Date :</strong> {{ checklist.date|date:"d/m/Y" }}</p>
        <p><strong>Adresse :</strong> {{ checklist.lieu }}</p>
        <p><strong>Heure de livraison :</strong> {{ checklist.heure_livraison }}</p>
        {% if checklist.notechecklist %}
          <p><strong>Infos :</strong> {{ checklist.notechecklist }}</p>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- Form pour ajouter une note -->
  <div class="mt-5">
    <h3>Ajouter une note pour les livreurs</h3>
    <form method="POST" action="{% url 'checklistvoir-detail' checklist.id %}">
      {% csrf_token %}
      <div class="mb-3">
        <textarea name="note" class="form-control" rows="4" placeholder="Ajoutez une note..." maxlength="500">{{ checklist.notechecklist }}</textarea>
      </div>
      <button type="submit" class="btn btn-success">
        <i class="fas fa-plus"></i> Ajouter / Modifier la note
      </button>
    </form>
  </div>

  <!-- Modal édition produit -->
  <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editItemModalLabel">Modifier Produit</h5>
            </div>
            <div class="modal-body">
                <form id="editItemForm">
                    {% csrf_token %}
                    <input type="hidden" id="edit-item-id" name="item_id">
                    <div class="form-group">
                        <label for="edit-product">Sélectionner le produit:</label>
                        <select id="edit-product" name="product" class="form-control">
                            {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-quantity">Quantité:</label>
                        <input type="number" id="edit-quantity" name="quantity" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="saveChanges">Sauvegarder</button>
            </div>
        </div>
    </div>
  </div>

</div>

<!-- Scripts pour gestion modale et actions -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<!-- Load Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

$(document).ready(function() {
    $('#editItemModal').on('shown.bs.modal', function () {
        $('#edit-product').select2({
            dropdownParent: $('#editItemModal'),
            width: '100%',
            placeholder: 'Sélectionner un produit',
            allowClear: true
        });
    });
});

  // Ouvrir modal pour modifier produit
  $(document).on('click', '.edit-item', function() {
    const itemId = $(this).data('id');
    const productId = $(this).data('product');
    const quantity = $(this).data('quantity');

    $('#edit-item-id').val(itemId);
    $('#edit-product').val(productId);
    $('#edit-quantity').val(quantity);
    $('#editItemModal').modal('show');
  });

  // Sauvegarder modifications via AJAX
  $('#saveChanges').click(function() {
    const itemId = $('#edit-item-id').val();
    const productId = $('#edit-product').val();
    const quantity = $('#edit-quantity').val();
    
    // Validation
    if (!itemId || !productId || !quantity) {
      alert('Veuillez remplir tous les champs');
      return;
    }
    
    // Créer un formulaire pour soumettre via POST normal
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{% url 'checklistvoir-detail' checklist.id %}";
    
    // Ajouter les champs
    const fields = {
      'item_id': itemId,
      'product_id': productId,
      'quantity': quantity,
      'action': 'update_item',
      'csrfmiddlewaretoken': '{{ csrf_token }}'
    };
    
    for (const [key, value] of Object.entries(fields)) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = value;
      form.appendChild(input);
    }
    
    document.body.appendChild(form);
    form.submit();
  });

  // Fonction simplifiée pour soumettre le formulaire de statut
  function submitStatusForm(itemId, newStatus) {
    const statusField = document.querySelector(`#status_${itemId}`);
    const form = document.querySelector(`#status-form-${itemId}`);

    if (statusField) {
        statusField.value = newStatus;  // Set the new status in the hidden input
    }

    form.submit(); // Submit the form
  }

  // Fonction pour imprimer la checklist
  function printChecklist() {
    const content = document.getElementById('print-section').innerHTML;
    const qrCodeData = "{{ qr_code_data_uri }}";

    const printWindow = window.open('', '', 'height=600,width=900');
    printWindow.document.write('<html><head><title>Impression Checklist</title>');
    printWindow.document.write(`
      <style>
        @page { size: A4 landscape; margin: 10mm; }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .page { display: flex; flex-direction: column; align-items: center; }
        h2 { margin-bottom: 20px; }
        img { max-width: 150px; margin-bottom: 20px; }
      </style>
    `);
    printWindow.document.write('</head><body>');
    printWindow.document.write('<div class="page">');
    printWindow.document.write(`<img src="${qrCodeData}" alt="QR Code">`);
    printWindow.document.write(content);
    printWindow.document.write('</div></body></html>');
    printWindow.document.close();
    printWindow.print();
  }

</script>

{% endblock %}