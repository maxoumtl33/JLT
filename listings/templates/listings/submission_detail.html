{% extends 'listings/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 0;
    color: #333;
    display: flex;
    height: 100vh;
    overflow: hidden;
    transition: background-color 0.3s linear, color 0.3s linear;
}

.card {
    border-radius: 10px;
}

.underline-green {
    text-decoration: underline;
    text-decoration-color: green;
}

.info-icon {
    margin-right: 20px !important;
    color: #007bff;
}

.card-body p {
    font-size: 1.1rem;
    line-height: 1.4;
    margin-bottom: 1rem;
}

.card-body p strong {
    color: #333;
}

.btn {
    border-radius: 20px;
}

.edit-section {
    margin-top: 5px;
}

.sidebar {
    width: 250px;
    background-color: #007BFF;
    height: 100%;
    padding: 20px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    overflow-y: auto;
}

.sidebar .sidebar-header {
    font-size: 24px;
    color: #fff;
    margin-bottom: 20px;
}

.sidebar a {
    color: #fff;
    display: block;
    padding: 10px;
    text-decoration: none;
    margin-bottom: 10px;
    border-radius: 8px;
    transition: background-color 0.3s;
}

.sidebar a.active, .sidebar a:hover {
    background-color: #0056b3;
    color: #fff;
    text-decoration: none;
}

.subcheck {
    flex: 1;
    padding: 20px;
    background-color: #F0F2F5;
    overflow-y: auto;
    transition: margin-left 0.3s ease;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 20px;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.header .toggle-theme {
    cursor: pointer;
    color: #007BFF;
}

#subcheck.expanded {
    margin-left: 0;
}

#subcheck.full-width {
    transition: margin-left 0s;
}

.collapsed {
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    width: 0;
}

.dark-mode {
    background-color: #121212;
    color: #e4e4e4;
}

.dark-mode .header, .dark-mode .card {
    background-color: #1e1e1e;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}

.dark-mode .sidebar {
    background-color: #1e1e1e;
}

.dark-mode .sidebar a {
    color: #e4e4e4;
}

.dark-mode .sidebar a.active, .dark-mode .sidebar a:hover {
    background-color: #333;
    color: #fff;
}

.highlight {
    color: #8CE78B;
}
</style>

<input type="hidden" id="current_submission_id" value="{{ submission.id }}">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<div class="sidebar" id="sidebar">
    <div class="sidebar-header" style="margin-top: 100px;">Menu <button class="toggle-sidebar" id="sidebar-toggle"><i class="fas fa-bars"></i></button></div>
    <a href="{% url 'conseiller_dashboard' %}" class="aref"><i class="fa-solid fa-desktop me-2"></i> Tableau de bord</a>
    <a href="{% url 'journees-list' %}" class="aref"><i class="fa-solid fa-truck me-2"></i> Livraisons</a>
    <a href="{% url 'creerchecklist' %}"><i class="fas fa-list-check me-2"></i> Checklists</a>
    <a href="{% url 'calendarsub_view' %}"><i class="fa-solid fa-file-contract me-2"></i>Soumissions</a>
    <a class="aref" href="{% url 'etiquette-tente' %}"><i class="fa-solid fa-print me-2"></i>Etiquette tente</a>

    {% if user.username == "Audrey" or user.username == "Maxime" or user.username == "Roxanne" %}
        <a href="{% url 'manage_submissions' %}"><i class="fa-solid fa-file-pdf me-2"></i>PDF et Recherche Soumission</a>
        <a href="{% url 'calendarsubcreate_view' %}"><i class="fa-solid fa-calendar-days me-2"></i>Suivi Soumissions</a>
    {% endif %}
                                
    <button class="toggle-theme" id="theme-toggle" style="margin-top:10px;"><i class="fas fa-moon"></i> Thème</button>
    <div style="margin-top:20px; font-size:14px; color:#ccc;">Utilisateur: {{ user.username }}</div>
</div>

<div class="subcheck" id="subcheck">
    <div class="header">
        {% if 'soumission' in submission.submission_type|lower %}
        <h2>Détails de la Soumission 
            {% if submission.status == "envoyé" %}
                <i class="fa-solid fa-paper-plane" style="color: #0056b3;"></i>
            {% endif %}
            {% if submission.status == "valide" %}
                <i class="fas fa-check-circle" style="color: #8CE78B;"></i>
            {% endif %}
            {% if submission.status == "refuse" %}
                <i class="fas fa-times-circle" style="color: red;"></i>
            {% endif %}
            {% if submission.status == "en_cours" %}
                <i class="fas fa-spinner fa-spin" style="color: orange;"></i>
            {% endif %}
        </h2>
        {% elif 'commande' in submission.submission_type|lower %}
        <h2>Détails de la Commande 
            {% if submission.status == "envoyé" %}
                <i class="fa-solid fa-paper-plane" style="color: #0056b3;"></i>
            {% endif %}
            {% if submission.status == "valide" %}
                <i class="fas fa-check-circle" style="color: #8CE78B;"></i>
            {% endif %}
            {% if submission.status == "refuse" %}
                <i class="fas fa-times-circle" style="color: red;"></i>
            {% endif %}
            {% if submission.status == "en_cours" %}
                <i class="fas fa-spinner fa-spin" style="color: orange;"></i>
            {% endif %}
        </h2>
        {% endif %}
        
        <button id="show-sidebar" style="display:none; position: fixed; top: 12%; left: 10px;">
            <i class="fas fa-bars fa-2xl"></i>
        </button>
        
        <div class="user-info">
            <button type="button" id="modifyButton" class="nav__link">
                <i class="fa-solid fa-pen-to-square"></i>
                <span>Remplir</span>
            </button>
            <button type="button" class="btn btn-success d-none" id="saveButton">
                Enregistrer les modifications
            </button>
        </div>
    </div>

    <br><br>
    <br><br>

    <button id="changeUserBtn" data-submission-id="{{ submission.id }}" class="btn btn-primary">
        Assigner utilisateur
    </button>
    <button id="printEventDetails" class="btn btn-primary">Imprimer PDF</button>
    <button id="btnAddNote" class="btn btn-primary">Ajouter Note</button>

    <!-- Modal pour sélectionner un nouvel utilisateur (Conseillers uniquement) -->
    <div class="modal fade" id="changeUserModal" tabindex="-1" aria-labelledby="changeUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeUserModalLabel">Assigner l'utilisateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <form id="changeUserForm">
                        <div class="mb-3">
                            <label for="newUserSelect" class="form-label">Sélectionnez un conseiller</label>
                            <select class="form-select" id="newUserSelect" required>
                                {% for conseiller in conseillers %}
                                    <option value="{{ conseiller.user.id }}" {% if conseiller.user.id == submission.user.id %}selected{% endif %}>
                                        {{ conseiller.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                    <div id="changeUserAlert" class="alert alert-info d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveChangeUser">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="d-flex justify-content-between align-items-center card-header bg-secondary text-white">
            <div>
                <h3 class="mb-0">{{ submission.submission_type }} / {{ submission.type_prise_de_commande }}</h3>
            </div>
        </div>
    </div>

    <div id="eventDetailsSection">
        <div class="card-body">
            <h3 class="mt-3" style="margin-bottom: 10px;">Détails de l'Événement</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <p><i class="fas fa-calendar-alt info-icon"></i>
                        <strong style="{% if submission.date %}border-bottom: 3px solid lightgreen; padding-bottom: 2px;{% endif %}">Date:</strong>
                        <span class="view-section">{{ submission.date|date:"d F Y" }}</span>
                        <input type="date" class="form-control edit-section d-none" name="date" value="{{ submission.date|date:"Y-m-d" }}" />
                    </p>
                </div>
                <div class="col-md-6">
                    <p><i class="fas fa-building info-icon"></i>
                        <strong style="{% if submission.company_name %}border-bottom: 3px solid lightgreen; padding-bottom: 2px;{% endif %}">Nom de la compagnie:</strong>
                        <span class="view-section">{{ submission.company_name|default_if_none:'' }}</span>
                        <input type="text" class="form-control edit-section d-none" name="company_name" value="{{ submission.company_name }}" />
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <p><i class="fas fa-users info-icon"></i>
                        <strong style="{% if submission.guest_count %}border-bottom: 3px solid lightgreen; padding-bottom: 2px;{% endif %}">Nombre de personnes:</strong>
                        <span class="view-section">{{ submission.guest_count|default_if_none:'' }}</span>
                        <input type="number" class="form-control edit-section d-none" name="guest_count" value="{{ submission.guest_count }}" />
                    </p>
                </div>
                <div class="col-md-6">
                    <p><i class="fa-solid fa-location-dot info-icon"></i>
                        <strong style="{% if submission.event_location %}border-bottom: 3px solid lightgreen; padding-bottom: 2px;{% endif %}">Adresse:</strong>
                        <span class="view-section">{{ submission.event_location|default_if_none:'' }} {{ submission.event_postcode|default_if_none:'' }}</span>
                        <input type="text" class="form-control edit-section d-none" name="event_location" value="{{ submission.event_location }}" placeholder="Adresse" />
                        <input type="text" class="form-control edit-section d-none mt-2" name="postal_code" value="{{ submission.event_postcode }}" placeholder="Code postal" />
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <p><i class="fa-solid fa-bell-concierge info-icon"></i>
                        <strong style="border-bottom: 3px solid lightgreen; padding-bottom: 2px;">Avec Service:</strong>
                        <span class="view-section">{{ submission.avec_service_md|yesno:"Oui,Non" }}</span>
                        <select class="form-control edit-section d-none" name="avec_service_md">
                            <option value="True" {% if submission.avec_service_md %}selected{% endif %}>Oui</option>
                            <option value="False" {% if not submission.avec_service_md %}selected{% endif %}>Non</option>
                        </select>
                    </p>
                </div>
                <div class="col-md-4">
                    <p><i class="fa-solid fa-truck-ramp-box info-icon"></i>
                        <strong style="border-bottom: 3px solid lightgreen; padding-bottom: 2px;">Location Matériel:</strong>
                        <span class="view-section">{{ submission.location_materiel|yesno:"Oui,Non" }}</span>
                        <select class="form-control edit-section d-none" name="location_materiel">
                            <option value="True" {% if submission.location_materiel %}selected{% endif %}>Oui</option>
                            <option value="False" {% if not submission.location_materiel %}selected{% endif %}>Non</option>
                        </select>
                    </p>
                </div>
                <div class="col-md-4">
                    <p><i class="fa-solid fa-wine-glass info-icon"></i>
                        <strong style="border-bottom: 3px solid lightgreen; padding-bottom: 2px;">Avec Alcool:</strong>
                        <span class="view-section">{{ submission.avec_alcool|yesno:"Oui,Non" }}</span>
                        <select class="form-control edit-section d-none" name="avec_alcool">
                            <option value="True" {% if submission.avec_alcool %}selected{% endif %}>Oui</option>
                            <option value="False" {% if not submission.avec_alcool %}selected{% endif %}>Non</option>
                        </select>
                    </p>
                </div>
            </div>

            <h3 class="mt-3" style="margin-bottom: 10px;">Coordonnées de Contact</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <p><i class="fas fa-user info-icon"></i>
                        <strong style="{% if submission.ordered_by %}border-bottom: 3px solid lightgreen; padding-bottom: 2px;{% endif %}">Commandé par:</strong>
                        <span class="view-section">{{ submission.ordered_by|default_if_none:'' }}</span>
                        <input type="text" class="form-control edit-section d-none" name="ordered_by" value="{{ submission.ordered_by }}" />
                    </p>
                </div>
                <div class="col-md-6">
                    <p><i class="fas fa-envelope info-icon"></i>
                        <strong style="{% if submission.email %}border-bottom: 3px solid lightgreen; padding-bottom: 2px;{% endif %}">Email:</strong>
                        <span class="view-section">{{ submission.email|default_if_none:'' }}</span>
                        <input type="email" class="form-control edit-section d-none" name="email" value="{{ submission.email }}" />
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <p><i class="fas fa-phone info-icon"></i>
                        <strong style="{% if submission.phone %}border-bottom: 3px solid lightgreen; padding-bottom: 2px;{% endif %}">Téléphone:</strong>
                        <span class="view-section">{{ submission.phone|default_if_none:'' }}</span>
                        <input type="tel" class="form-control edit-section d-none" name="phone" value="{{ submission.phone }}" />
                    </p>
                </div>
            </div>

            <h3 class="mt-3" style="margin-bottom: 10px;">Détails de Création</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><i class="fas fa-calendar-check info-icon"></i><strong>Créé à:</strong> {{ submission.created_at|date:"d F Y, H:i" }}</p>
                </div>
                <div class="col-md-6">
                    <p><i class="fa-solid fa-user info-icon"></i><strong>Par:</strong> {{ submission.user.username }}</p>
                </div>
            </div>
            <br>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>

<script>
// Fonction pour basculer entre mode lecture et édition
document.getElementById('modifyButton').addEventListener('click', function() {
    document.querySelectorAll('.view-section').forEach(el => el.classList.toggle('d-none'));
    document.querySelectorAll('.edit-section').forEach(el => el.classList.toggle('d-none'));
    
    this.classList.toggle('d-none');
    document.getElementById('saveButton').classList.toggle('d-none');
});

// Fonction pour sauvegarder les modifications
document.getElementById('saveButton').addEventListener('click', function() {
    const formData = new FormData();
    
    // Collecter les données de tous les champs
    const inputs = document.querySelectorAll('.form-control:not(.d-none)');
    inputs.forEach(input => {
        formData.append(input.name, input.value);
    });

    // Envoyer les données au serveur
    fetch("{% url 'update_submission' submission.id %}", {
        method: "POST",
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("Une erreur s'est produite lors de la sauvegarde des modifications: " + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("Une erreur s'est produite lors de la sauvegarde des modifications.");
    });
});

// Gestion du thème sombre
const toggleBtn = document.getElementById('theme-toggle');
toggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
});

// Gestion de la sidebar
document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const btnShowSidebar = document.getElementById('show-sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    const subcheck = document.getElementById('subcheck');

    toggleBtn.addEventListener('click', () => {
        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            btnShowSidebar.style.display = 'none';
            subcheck.classList.remove('full-width');
        } else {
            sidebar.classList.add('collapsed');
            btnShowSidebar.style.display = 'block';
            subcheck.classList.add('full-width');
        }
    });

    btnShowSidebar.addEventListener('click', () => {
        sidebar.classList.remove('collapsed');
        btnShowSidebar.style.display = 'none';
        subcheck.classList.remove('full-width');
    });
});

// Gestion du changement d'utilisateur (Conseillers uniquement)
let currentSubmissionId = null;

document.addEventListener('DOMContentLoaded', () => {
    const btnChangeUser = document.getElementById('changeUserBtn');
    if (btnChangeUser) {
        currentSubmissionId = btnChangeUser.dataset.submissionId;

        btnChangeUser.addEventListener('click', () => {
            const modalEl = document.getElementById('changeUserModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        });
    }

    const saveBtn = document.getElementById('saveChangeUser');
    if (saveBtn) {
        saveBtn.onclick = () => {
            const selectedUserId = document.getElementById('newUserSelect').value;
            if (!currentSubmissionId) {
                alert('ID de la soumission introuvable.');
                return;
            }

            fetch("{% url 'change-user' submission.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ user_id: selectedUserId })
            })
            .then(res => res.json())
            .then(data => {
                const alertDiv = document.getElementById('changeUserAlert');
                if (data.success) {
                    alertDiv.classList.remove('d-none', 'alert-danger');
                    alertDiv.classList.add('alert-success');
                    alertDiv.textContent = 'Utilisateur modifié avec succès.';
                    setTimeout(() => { location.reload(); }, 1500);
                } else {
                    alertDiv.classList.remove('d-none', 'alert-success');
                    alertDiv.classList.add('alert-danger');
                    alertDiv.textContent = "Erreur: " + data.error;
                }
            })
            .catch(error => {
                console.error('Erreur fetch:', error);
                alert('Une erreur est survenue.');
            });
        };
    }
});

// Fonction d'impression PDF
document.getElementById('printEventDetails').addEventListener('click', function() {
    const content = document.getElementById('eventDetailsSection').innerHTML;
    const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]')).map(tag => tag.outerHTML).join('');
    
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Impression Détails de l\'Événement</title>');
    printWindow.document.write(styles);
    printWindow.document.write('</head><body>');
    printWindow.document.write('<div class="card-body">');
    printWindow.document.write(content);
    printWindow.document.write('</div>');
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
});

// Fonction pour ajouter une note
document.getElementById('btnAddNote').addEventListener('click', function() {
    const currentNote = '{{ submission.note|default:"" }}';
    const newNote = prompt('Entrez votre note:', currentNote);
    if (newNote !== null) {
        fetch("{% url 'add_note' submission.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ note: newNote })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Note enregistrée!');
                location.reload();
            } else {
                alert('Erreur lors de l\'enregistrement de la note.');
            }
        });
    }
});

// Variable pour tracker les changements non sauvegardés
let isDirty = false;

document.querySelectorAll('input, select, textarea').forEach(element => {
    element.addEventListener('change', () => {
        isDirty = true;
    });
});

document.getElementById('modifyButton').addEventListener('click', () => {
    isDirty = true;
});

document.getElementById('saveButton').addEventListener('click', () => {
    isDirty = false;
});

window.addEventListener('beforeunload', (e) => {
    if (isDirty) {
        const confirmationMessage = 'Tu n\'as pas enregistré. Êtes-vous sûr de vouloir quitter cette page ?';
        (e || window.event).returnValue = confirmationMessage;
        return confirmationMessage;
    }
});
</script>

{% endblock %}