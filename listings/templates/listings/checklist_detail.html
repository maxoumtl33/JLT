{% extends 'listings/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>

body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s linear, color 0.3s linear;
        }
/* Exemples, √† int√©grer dans votre fiche style ou <style> */
    .hover-shadow:hover {
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  transition: box-shadow 0.3s ease;
}
.rapport-section {
  margin-bottom: 2rem;
  transition: all 0.3s ease;
}
.btn-primary {
  transition: background-color 0.2s, box-shadow 0.2s;
}
.btn-primary:hover {
  background-color: #0069d9;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
        .sidebar {
            width: 250px;
            background-color: #007BFF;
            height: 100%;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .sidebar .sidebar-header {
            font-size: 24px;
            color: #fff;
            margin-bottom: 20px;
        }

        .sidebar a {
            color: #fff;
            display: block;
            padding: 10px;
            text-decoration: none;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .sidebar a.active, .sidebar a:hover {
            background-color: #0056b3;
        }

        .checklistsss {
            flex: 1;
            padding: 20px;
            background-color: #F0F2F5;
            overflow-y: auto;
            transition: margin-left 0.3s ease; /* Improves smoothness of layout change */
        }


        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            
        }

        .header .toggle-theme {
            cursor: pointer;
            color: #007BFF;
        }
        #checklistsss.expanded {
    margin-left: 0;
}

#checklistsss.full-width {
    transition: margin-left 0s;
}

.collapsed {
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    width: 0; /* Ensure width collapses at the end */
}

.dark-mode {
            background-color: #121212;
            color: #e4e4e4;
        }

        .dark-mode .header, .dark-mode .card {
            background-color: #1e1e1e;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .dark-mode .sidebar {
            background-color: #1e1e1e;
        }

        .dark-mode .sidebar a {
            color: #e4e4e4;
        }

        .dark-mode .sidebar a.active, .dark-mode .sidebar a:hover {
            background-color: #333;
            color: #fff;
        }
/* Styles pour distinguer cat√©gories normales et sp√©ciales */
.category-normal {
  background-color: #f8f9fa; /* gris clair */
  transition: transform 0.2s, box-shadow 0.2s;
}
.category-normal:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.category-special {
  background-color: #007bff; /* bleu Bootstrap */
  color: #fff;
  transition: transform 0.2s, box-shadow 0.2s;
}
.category-special:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Ic√¥ne style global si besoin */
.card i {
  transition: color 0.2s;
}

/* Styles pour les statuts */
.status-valide {
    background-color: #28a745 !important;
    color: white !important;
}

.status-en-cours {
    background-color: #ffc107 !important;
    color: black !important;
}

.status-refuse {
    background-color: #dc3545 !important;
    color: white !important;
}
</style>
<!-- Inclure Bootstrap CSS et JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<div class="sidebar" id="sidebar">
  <div class="sidebar-header" style="margin-top: 100px;">Menu <button class="toggle-sidebar" id="sidebar-toggle"><i class="fas fa-bars"></i></button></div>
  <a href="{% url 'conseiller_dashboard' %}" class="aref"><i class="fa-solid fa-desktop me-2"></i> Tableau de bord</a>
  <a href="{% url 'journees-list' %}" class="aref"><i class="fa-solid fa-truck me-2"></i> Livraisons</a>
  <a href="{% url 'creerchecklist' %}"><i class="fas fa-list-check me-2"></i> Checklists</a>
  <a href="{% url 'calendarsub_view' %}">
    <i class="fa-solid fa-file-contract me-2"></i>Soumissions
                                        </a>
  
  <a href="{% url 'submit_request' %}" target="_blank" class="aref" >
    <i class="fa-solid fa-file-signature me-2"></i>Cr√©er Soumission
                            </a>
                        
                            <a class="aref" href="{% url 'etiquette-tente' %}"><i class="fa-solid fa-print me-2"></i>Etiquette tente</a>

                            {% if user.username == "Audrey" or user.username == "Maxime" or user.username == "Roxanne" %}
                            
                             
                                
                                        <a href="{% url 'manage_submissions' %}">
                                            <i class="fa-solid fa-file-pdf me-2"></i>PDF et Recherche Soumission
                                        </a>
                                   
                                        <a href="{% url 'calendarsubcreate_view' %}">
                                            <i class="fa-solid fa-calendar-days me-2"></i>Suivi Soumissions
                                        </a>
                                  
                                        
                           
                            {% endif %}
                              
  <button class="toggle-theme" id="theme-toggle" style="margin-top:10px;"><i class="fas fa-moon"></i> Th√®me</button>
  <div style="margin-top:20px; font-size:14px; color:#ccc;">Utilisateur: {{ user.username }}</div>
</div>

<div class="checklistsss" id="checklistsss">

    <div class="header">
        <h2>Checklist {{ checklist.name }}</h2>
            <button id="show-sidebar" style="display:none; position: fixed; top: 12%; left: 10px;">
                <i class="fas fa-bars fa-2xl"></i>
            </button>
            
              
        <div class="user-info">
            <button id="toggleCartBtn" class="btn btn-primary" style="position: fixed; top: 10px; right: 10px; z-index: 1050;">
                üõí Voir le Panier
              </button>
        </div>
    </div>
    <br>
    <br>
    <br>
    <br>
    <div style="display: flex;">
    <button onclick="downloadChecklistItemsGroupedPDF()" class="btn btn-secondary mb-3" style="margin-right: 10px;">
        T√©l√©charger les produits (PDF)
        <i class="fa-solid fa-file-pdf"></i>
      </button>
      <button onclick="downloadChecklistItemsGroupedBreuvagePDF()" class="btn btn-secondary mb-3" style="margin-right: 10px;">
        T√©l√©charger les breuvages (PDF)
        <i class="fa-solid fa-file-pdf"></i>
      </button>
      <form action="{% url 'duplicate-checklist' checklist_id=checklist.id %}" method="POST">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary mb-3" style="margin-right: 10px;"> Dupliquer
          <i class="fa-solid fa-copy"></i>
      </button>
    </form>
    <button type="button" class="btn btn-secondary mb-3" data-bs-toggle="modal" data-bs-target="#statusModal">
      Voir Statuts des Produits
      <i class="fa-solid fa-chart-simple"></i>
  </button>

    
</div>
<!-- Modal pour voir les statuts -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="statusModalLabel">Statuts des Produits</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div id="statusContent">
                  {% for cat_name, items in checklist_items_by_category.items %}
                      {% if cat_name != "SOUMISSIONS" %}
                      <h5 class="mt-3">{{ cat_name }}</h5>
                      <table class="table table-bordered table-hover">
                          <thead>
                              <tr>
                                  <th style="width: 40%">Produit</th>
                                  <th style="width: 15%">Quantit√©</th>
                                  <th style="width: 20%">Statut</th>
                              </tr>
                          </thead>
                          <tbody>
                              {% for item in items %}
                              <tr>
                                  <td>{{ item.product.name }}</td>
                                  <td>{{ item.quantity }}</td>
                                  <td>
                                    <span class="badge rounded-pill 
                                        {% if item.status == 'valide' %}status-valide
                                        {% elif item.status == 'en_cours' %}status-en-cours
                                        {% elif item.status == 'pending' %}status-en-cours
                                        {% elif item.status == 'refuse' or item.status == 'refused' %}status-refuse
                                        {% elif item.status == 'complete' %}status-valide
                                        {% endif %}">
                                        {% if item.status == 'pending' %}en_cours{% else %}{{ item.status|default:"en_cours" }}{% endif %}
                                    </span>
                                </td>
                              </tr>
                              {% endfor %}
                          </tbody>
                      </table>
                      {% endif %}
                  {% endfor %}
              </div>
          </div>
      </div>
  </div>
</div>


    <div class="d-flex justify-content-between flex-wrap gap-3 p-3 bg-light rounded shadow">
        <div class="info-card">
          <p id="date"><strong><i class="bi bi-calendar-event"></i> Date √©v√©nement:</strong> {{ checklist.date|date:"d/m/Y" }}</p>
          <p><strong><i class="bi bi-geo-alt"></i> Lieu √©v√©nement:</strong> {{ checklist.lieu }}</p>
          <p><strong><i class="bi bi-people"></i> Nombre convives:</strong> {{ checklist.nb_convive }}</p>
        </div>
    
        <div class="info-card">
          <p><strong><i class="bi bi-clock"></i> Heure de livraison:</strong> {{ checklist.heure_livraison }}</p>
          <p id="numContrat"><strong><i class="bi bi-file-earmark-text"></i> Num√©ro de contrat:</strong> {{ checklist.num_contrat }}</p>
        </div>
    
        <div class="info-card">
          <p id="conseiller"><strong><i class="bi bi-person-circle"></i> Conseiller(e):</strong> {{ checklist.conseillere }}</p>
          <p><strong><i class="bi bi-person-badge"></i> Nom du MD:</strong> {{ checklist.md }}</p>
        </div>
        
        <div class="info-card">
            <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModals" style="text-decoration:none;">
                <i class="fa-solid fa-pen-to-square me-2"></i> Modifier
                </a>
                <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalsinfos" style="text-decoration:none;">
                    <i class="fa-solid fa-asterisk me-2"></i> Infos
                    </a>
        </div>
      </div>
    
      <div class="mt-4 d-flex flex-column align-items-center gap-3">
        <!-- Boutons principaux (ajouter documents et commentaire MD) -->
        <div class="d-flex justify-content-center gap-3">
          <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#documentModal">
            <i class="bi bi-folder"></i> Ajouter documents
          </button>
          <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#exampleModalcommentairemd">
            <i class="fa-solid fa-comment"></i> Commentaire MD
          </button>
        </div>
        
      </div>
      

<h2>Produits</h2>
<hr>
<div class="d-flex flex-wrap gap-3 mb-4">
    {% for category in categories %}
    {% if not category.name in special_categories and category.name != "SOUMISSIONS"%}
        {% with icon=category_icons|get_item:category.name %}
        <div class="card text-center shadow-sm" style="width: 20%; cursor: pointer;"
             data-bs-toggle="modal" data-bs-target="#productModal"
             data-category-name="{{ category.name }}">
          <div class="card-body">
            <div class="mb-2">
              <i class="fas {{ icon }}" style="font-size: 2rem; color: #0069d9;"></i>
            </div>
            <h6>{{ category.name }}</h6>
          </div>
        </div>
        {% endwith %}
      {% endif %}
    {% endfor %}
    </div>

<h2>Breuvages</h2>
<hr>
<div class="d-flex flex-wrap gap-3 mb-4">
    {% for category in categories %}
      {% if category.name in special_categories %}
        {% with icon=category_icons|get_item:category.name %}
        <div class="card text-center shadow-sm" style="width: 20%; cursor: pointer;"
             data-bs-toggle="modal" data-bs-target="#productModal"
             data-category-name="{{ category.name }}">
          <div class="card-body">
            <div class="mb-2">
              <i class="fas {{ icon }}" style="font-size: 2rem; color: #0069d9;"></i>
            </div>
            <h6>{{ category.name }}</h6>
          </div>
        </div>
        {% endwith %}
      {% endif %}
    {% endfor %}
    </div>
    

  

<!-- Modal pour rechercher et s√©lectionner les produits -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Produits</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="searchInput" placeholder="Rechercher un produit...">
        <div class="list-group" id="productList"></div>
      </div>
    </div>
  </div>
</div>

<h2>Rapports MD</h2>
<hr>

<!-- Toggle buttons for rapports-->
<div class="d-flex gap-3 mb-4">
  <button type="button" class="btn btn-primary toggle-btn" data-target="#rapportmd-section">
    <i class="bi bi-file-earmark-text"></i> Rapport √©v√©nement
    <i class="bi bi-chevron-down ms-2 toggle-icon"></i>
  </button>
  <button type="button" class="btn btn-primary toggle-btn" data-target="#rapportbreuvage-section">
    <i class="fa-solid fa-champagne-glasses"></i> Rapport breuvage
    <i class="bi bi-chevron-down ms-2 toggle-icon"></i>
  </button>
</div>

<!-- Rapport MD -->
<div id="rapportmd-section" class="rapport-section collapse">
  <div class="card p-3 shadow-sm bg-light border-0 rounded-3">
    <h3>Rapport √©v√©nement</h3>
    <p>{{ checklist.rapportmd|linebreaksbr }}</p>
  </div>
</div>

<!-- Rapport Breuvage -->
<div id="rapportbreuvage-section" class="rapport-section collapse">
  <div class="card p-3 shadow-sm bg-light border-0 rounded-3 mb-3">
    <h3>Rapport Breuvage</h3>
    <button onclick="generatePDFbreuvage()" class="btn btn-secondary mb-3">
      <i class="fa-solid fa-file-pdf"></i> T√©l√©charger en PDF
    </button>
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Total</th>
          <th>Restant</th>
          <th>Consomm√©</th>
        </tr>
      </thead>
      <tbody>
        {% for breuvage in breuvages %}
        <tr>
          <td>{{ breuvage.product.name }}</td>
          <td>{{ breuvage.quantity }}</td>
          <td>{{ breuvage.consumed_quantity }}</td>
          <td>{{ breuvage.quantity|subtract:breuvage.consumed_quantity }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<h2>Photos √âv√©nement</h2>
<hr>
<div class="d-flex gap-3 mb-3">
  <button type="button" class="btn btn-primary toggle-btn" data-target="#photo-gallery-evenement">
    <i class="bi bi-image"></i> Photos √©v√©nement
    <i class="bi bi-chevron-down ms-2 toggle-icon"></i>
  </button>
  <button type="button" class="btn btn-primary toggle-btn" data-target="#photo-gallery-recup">
    <i class="bi bi-image"></i> Photos r√©cup√©ration
    <i class="bi bi-chevron-down ms-2 toggle-icon"></i>
  </button>
</div>

<!-- Photos √©v√©nements -->
<div id="photo-gallery-evenement" class="rapport-section collapse">
  <div class="row g-2">
    {% for photo in md_photos %}
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm hover-shadow rounded-3 overflow-hidden">
        <img src="{{ photo.image.url }}" class="card-img-top" alt="MD Photo" style="cursor:pointer;" onclick="openModal('{{ photo.image.url }}')">
      </div>
    </div>
    {% empty %}
    <p class="text-muted">Pas de photos.</p>
    {% endfor %}
  </div>
</div>

<!-- Photos r√©cup√©ration -->
<div id="photo-gallery-recup" class="rapport-section collapse">
  <div class="row g-2">
    {% for photo in recup_photos %}
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm hover-shadow rounded-3 overflow-hidden">
        <img src="{{ photo.image.url }}" class="card-img-top" alt="Recup Photo" style="cursor:pointer;" onclick="openModal('{{ photo.image.url }}')">
    </div>
  </div>
  {% empty %}
  <p class="text-muted">Pas de photos.</p>
  {% endfor %}
</div>
</div>


  
      <!-- Modal Structure for Photo Viewing -->
      <div id="photoModal" class="modal" onclick="closeModal()">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content-wrapper">
          <img class="modal-content" id="modalImg">
          <a id="downloadBtn" class="download-btn" href="#" download>
              <i class="fa fa-download"></i> T√©l√©charger
          </a>
        </div>
      </div>
  
<!-- Panier avec commentaires -->
<div id="cartContainer" style="display: none; position: fixed; top: 50px; right: 10px; width: 450px; max-height: 50vh; overflow-y: auto; background: #fff; border: 1px solid #ccc; padding: 10px; z-index: 1050; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
  <h5>Votre Panier</h5>
  <table class="table table-sm" id="cart-table">
    <thead>
      <tr>
        <th>Produit</th>
        <th>Quantit√©</th>
        <th>Commentaire</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="btn btn-primary" onclick="submitCart()">Valider le panier</button>
</div>
  

        <!-- Document Modal -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentModalLabel">Ajouter des documents</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="documentForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="file" name="document" class="form-control mb-2">
                    <button type="submit" class="btn btn-success">Ajouter Document</button>
                </form>
                <hr>
                <ul id="documentList">
                    {% for document in checklist_documents %}
                    <li>
                        <a href="{{ document.document.url }}" target="_blank"><i class="fa-solid fa-eye fa-2xl" style="color: #74C0FC;"></i></a>
                        <button class="delete-doc" data-id="{{ document.id }}" style="margin-left: 20px; margin-bottom: 30px;">
                            <i class="fa-solid fa-trash fa-2xl" style="color: #f51919;"></i>
                        </button>
                    </li>
                   
                    {% endfor %}
                </ul>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

  <!-- Modal for modifying checklist -->
  <div class="modal fade modal-xlg" id="exampleModals" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modifier Checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" method="POST">
                    {% csrf_token %}
                    {{ formbis.as_p }}
                    <input type="submit" value="Valider" class="btn btn-primary" name="submit_checklist">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-xlg" id="exampleModalsinfos" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Ajouter informations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" id='checklistinfos_form' method="POST">
                    {% csrf_token %}
                    {{ forminfo.as_p }}
                    <input type="submit" value="Valider" class="btn btn-primary" name="submit_checklistinfos">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal for commentaire ventes -->

<div class="modal fade" id="exampleModalcommentairemd" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Ajouter un commentaire MD</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'checklist-detail' checklist.id %}" id="commentairemdForm">
                    {% csrf_token %}
                    {{ commentairemd_form.as_p }}
                    <button type="submit" class="btn btn-primary" name="submit_commentaire">Envoyer</button>
                </form>

            </div>
        </div>
    </div>
</div>


</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

{{ existing_items|json_script:"existingItems" }}
{{ product_quantities|json_script:"productQuantities" }}
  
<script>
// Variables globales
var uploadDocumentUrl = "{% url 'upload_document' checklist.id %}";
const existingItems = JSON.parse(document.getElementById('existingItems').textContent);
const productQuantities = JSON.parse(document.getElementById('productQuantities').textContent);
const cart = existingItems.map(e => ({
  id: e.id,  // ID de ChecklistItem
  product_id: e.product_id,
  name: e.product__name,
  quantity: e.quantity,
  commentaire: e.commentaire || ''  // Ajouter le commentaire existant
}));
let currentCategory = '';

// Lorsqu'on ouvre la modal, charger les produits de la cat√©gorie s√©lectionn√©e
const productModal = document.getElementById('productModal');

productModal.addEventListener('show.bs.modal', function (event) {
  const button = event.relatedTarget;
  currentCategory = button.getAttribute('data-category-name');
  document.getElementById('productModalLabel').innerText = 'Produits - ' + currentCategory;
  loadProducts(currentCategory);
  document.getElementById('searchInput').value = '';
});

function updateAddButtons() {
  document.querySelectorAll('.card').forEach(card => {
    const btn = card.querySelector('button[data-product-id]');
    const productId = parseInt(btn.dataset.productId);
    const exists = cart.some(i => i.product_id === productId && i.quantity > 0);
    if (!exists) {
      btn.innerHTML = '<i class="fas fa-plus me-1"></i> Ajouter'; // Change to "Ajouter"
      btn.disabled = false; // Enable button
    } else {
      btn.innerHTML = '<i class="fa-solid fa-check"></i> Ajout√©'; // Change text to "Ajout√©"
      btn.disabled = true; // Disable button
    }
  });
}
function escapeForJS(str) {
  return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// Charger les produits d'une cat√©gorie avec recherche
function loadProducts(categoryName, searchTerm='') {
  const specialCategories = ["ALCOOL FORT", "BIERES", "SANS ALCOOL", "VINS"];
  const showStock = specialCategories.includes(categoryName);
  
  fetch(`{% url 'get_products_by_category' %}?category=${encodeURIComponent(categoryName)}&search=${encodeURIComponent(searchTerm)}`)
    .then(res => res.json())
    .then(data => {
      const listContainer = document.getElementById('productList');
      listContainer.innerHTML = '';
      if (data.products.length === 0) {
        listContainer.innerHTML = '<p class="text-muted">Aucun produit trouv√©.</p>';
      } else {
        data.products.forEach(prod => {
          const totalQty = productQuantities[prod.id] || 0;
          const existingInCart = cart.some(i => i.product_id === prod.id);
          const currentCartItem = cart.find(i => i.product_id === prod.id);
          const safeName = escapeForJS(prod.name);
          const btnLabel = !existingInCart || currentCartItem.quantity === 0 ? '<i class="fas fa-plus me-1"></i> Ajouter' : '<i class="fa-solid fa-check"></i> Ajout√©';
          const btnDisabled = !existingInCart || currentCartItem.quantity === 0 ? '' : 'disabled';
          
          // Afficher le stock seulement pour les cat√©gories sp√©ciales
          const stockInfo = showStock ? ` <span class="text-muted small">(${getProductQuantityInCart(prod.id) || 0} / ${totalQty} en stock)</span>` : '';
          
          const item = document.createElement('div');
          item.className = 'card shadow-sm rounded mb-3';
          item.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0 text-truncate">
                      ${prod.name}${stockInfo}
                  </h6>
                  <button class="btn btn-sm btn-outline-primary" ${btnDisabled} onclick="addProductToCart(${prod.id}, '${safeName}', this)" data-product-id="${prod.id}">
                     ${btnLabel}
                  </button>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <input type="number" min="1" class="form-control form-control-sm" placeholder="${getProductQuantityInCart(prod.id) || 0}" style="width:90px" data-product-id="${prod.id}">
                </div>
            </div>`;
          listContainer.appendChild(item);
        });
        updateAddButtons();
      }
    });
}
// Fonction pour obtenir la quantit√© si elle existe dans le panier
function getProductQuantityInCart(productId) {
  const item = cart.find(i => i.product_id === productId);
  return item ? item.quantity : 0;
}

// Recherche en temps r√©el
document.getElementById('searchInput').addEventListener('input', function() {
  const searchTerm = this.value
  loadProducts(currentCategory, searchTerm);
});

// Fonction pour ajouter un produit au panier
function addProductToCart(productId, productName, btn) {
  const parent = btn.closest('.card-body');
  const qtyInput = parent.querySelector('input[type="number"]');
  const quantity = parseInt(qtyInput.value);

  if (isNaN(quantity) || quantity <= 0) {
    alert('Entrez une quantit√© valable.');
    return;
  }

  fetch(`{% url 'add_products_to_checklist' checklist.id %}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({
      items: [{ product_id: productId, quantity: quantity, commentaire: '' }]
    })
  }).then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Ajout√©';
        btn.disabled = true;

        // Chercher si l'item existe d√©j√† dans le panier
        const existingIndex = cart.findIndex(i => i.product_id === productId);
        
        if (existingIndex !== -1) {
          // Mettre √† jour l'item existant avec l'ID retourn√©
          cart[existingIndex].quantity = quantity;
          if (data.item_id) {
            cart[existingIndex].id = data.item_id;
          }
        } else {
          // Ajouter un nouvel item avec l'ID retourn√©
          cart.push({ 
            id: data.item_id || null,
            product_id: productId, 
            name: productName, 
            quantity: quantity, 
            commentaire: '' 
          });
        }
        
        updateAddButtons();
        renderCart();
      } else {
        alert('Erreur lors de l\'ajout.');
      }
    });
}

// Modifier la quantit√© dans le panier
function updateCartItemQuantity(index, newQuantity) {
  if (newQuantity <= 0 || isNaN(newQuantity)) {
    alert('Quantit√© invalide');
    return;
  }
  cart[index].quantity = newQuantity;
  renderCart();
}

// Supprimer un produit du panier
function removeCartItem(index) {
  cart.splice(index, 1);
  renderCart();
}

// Fonction pour afficher le contenu du panier
function renderCart() {
    const tbody = document.querySelector('#cart-table tbody');
    tbody.innerHTML = '';

    cart.forEach((item, index) => {
        if (item.quantity > 0) {
            const row = document.createElement('tr');

            // Nom du produit
            const cellName = document.createElement('td');
            cellName.innerText = item.name;
            cellName.style.width = '40%';
            row.appendChild(cellName);

            // Quantit√©
            const cellQty = document.createElement('td');
            const inputQty = document.createElement('input');
            inputQty.type = 'number';
            inputQty.min = '0';
            inputQty.value = item.quantity;
            inputQty.className = 'form-control form-control-sm';
            inputQty.style.width = '70px';
            
            // Stocker l'index dans le cart pour les nouveaux items sans ID
            inputQty.dataset.cartIndex = index;
            
            if (item.id) {
                inputQty.dataset.checklistItemId = item.id;
            }
            
            inputQty.onchange = () => {
                const newVal = parseInt(inputQty.value);
                const checklistItemId = inputQty.dataset.checklistItemId;
                const cartIndex = parseInt(inputQty.dataset.cartIndex);
                
                if (checklistItemId && !isNaN(parseInt(checklistItemId))) {
                    // Item existant avec ID - appeler le serveur
                    updateQuantity(parseInt(checklistItemId), newVal);
                } else {
                    // Nouvel item sans ID - mettre √† jour localement
                    cart[cartIndex].quantity = newVal;
                }
            };
            
            cellQty.style.width = '20%';
            cellQty.appendChild(inputQty);
            row.appendChild(cellQty);

            // Commentaire
            const cellComment = document.createElement('td');
            const inputComment = document.createElement('input');
            inputComment.type = 'text';
            inputComment.className = 'form-control form-control-sm';
            
            if (item.commentaire && item.commentaire.trim() !== '') {
                inputComment.placeholder = item.commentaire;
                inputComment.value = item.commentaire;
            } else {
                inputComment.placeholder = 'Ajouter un commentaire...';
                inputComment.value = '';
            }
            
            inputComment.dataset.cartIndex = index;
            if (item.id) {
                inputComment.dataset.checklistItemId = item.id;
            }
            
            inputComment.onblur = () => {
                const checklistItemId = inputComment.dataset.checklistItemId;
                const cartIndex = parseInt(inputComment.dataset.cartIndex);
                
                if (checklistItemId && !isNaN(parseInt(checklistItemId))) {
                    updateItemComment(parseInt(checklistItemId), inputComment.value);
                } else {
                    // Nouvel item - stocker le commentaire localement
                    cart[cartIndex].commentaire = inputComment.value;
                }
            };
            
            cellComment.style.width = '40%';
            cellComment.appendChild(inputComment);
            row.appendChild(cellComment);

            tbody.appendChild(row);
        }
    });
}

renderCart();

// Envoyer le panier au backend
function submitCart() {
  if (cart.length === 0) {
    alert('Le panier est vide.');
    return;
  }

  fetch("{% url 'add_products_to_checklist' checklist.id %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ items: cart })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      alert('Produits ajout√©s avec succ√®s!');
      window.location.href = "{% url 'checklist-detail' checklist.id %}";
    } else {
      alert('Une erreur est survenue.');
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors de l\'envoi.');
  });
}

// Fonction pour mettre √† jour la quantit√©
function updateQuantity(checklistItemId, newQuantity) {
    if (!checklistItemId || isNaN(checklistItemId)) {
        console.log("Pas d'ID valide pour cet item");
        return;
    }

    console.log("Mise √† jour de l'item", checklistItemId, "avec quantit√©", newQuantity);
    
    fetch(`{% url 'update_checklist_item_quantity' 0 %}`.replace('0', checklistItemId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ quantity: newQuantity })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'ok') {
            const item = cart.find(i => i.id === checklistItemId);
            if (item) {
                item.quantity = newQuantity;
                if (data.item_status) {
                    item.status = data.item_status;
                }
            }
            console.log("Quantit√© mise √† jour avec succ√®s pour l'item", checklistItemId);
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur lors de la mise √† jour:', error);
    });
}
const toggleBtn = document.getElementById('theme-toggle');
        toggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

          document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const btnShowSidebar = document.getElementById('show-sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    const dashboard = document.getElementById('dashboard');

    // Quand on clique sur le bouton toggle pour cacher ou r√©afficher
    toggleBtn.addEventListener('click', () => {
        if (sidebar.classList.contains('collapsed')) {
            // La sidebar est masqu√©e, on la remonte
            sidebar.classList.remove('collapsed');
            btnShowSidebar.style.display = 'none';   // cache le bouton
            dashboard.classList.remove('full-width');
        } else {
            // La sidebar est visible, on la cache
            sidebar.classList.add('collapsed');
            btnShowSidebar.style.display = 'block';  // montre le bouton pour la r√©afficher
            dashboard.classList.add('full-width');
        }
    });

    // Quand on clique sur le bouton pour faire r√©appara√Ætre la sidebar
    btnShowSidebar.addEventListener('click', () => {
        sidebar.classList.remove('collapsed');
        btnShowSidebar.style.display = 'none'; // cache le bouton
        dashboard.classList.remove('full-width');
    });
});

document.getElementById('toggleCartBtn').addEventListener('click', function() {
  const container = document.getElementById('cartContainer');
  if (container.style.display === 'none') {
    // Mettre √† jour le contenu du panier
    renderCart();
    container.style.display = 'block';
  } else {
    container.style.display = 'none';
  }
});

// Modal Functions
function openModal(imageUrl) {
    const modal = document.getElementById("photoModal");
    const modalImg = document.getElementById("modalImg");
    const downloadBtn = document.getElementById("downloadBtn");

    // Set image URL for display and download
    modalImg.src = imageUrl;
    downloadBtn.href = imageUrl;

    modal.style.display = "flex";  // Show modal with flex centering
}

function closeModal() {
    document.getElementById("photoModal").style.display = "none";
}

$(document).ready(function() {
    // Handle document form submission
    $('#documentForm').submit(function(event) {
        event.preventDefault(); // Prevent default form submission

        var formData = new FormData(this); // Collect form data

        $.ajax({
            url: uploadDocumentUrl, // Adjust your URL here
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                alert("Document t√©l√©charg√© avec succ√®s !");
                // You might append the new document to the list here
                location.reload(); // Optionally reload if you update the list dynamically
            },
            error: function(xhr, status, error) {
                alert("Error");
            }
        });
    });

    function getCSRFToken() {
        const name = "csrftoken=";
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(';');
        for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i];
            while (cookie.charAt(0) === ' ') {
                cookie = cookie.substring(1);
            }
            if (cookie.indexOf(name) === 0) {
                return cookie.substring(name.length, cookie.length);
            }
        }
        return ""; // CSRF token not found
    }
    

    $('.delete-doc').click(function() {
    var docId = $(this).data('id');
    if (confirm("Es-tu s√ªr de vouloir supprimer ce document ?")) {
        $.ajax({
            url: "/delete_document/" + docId + "/", // This path should match your urls.py
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken()
            },
            success: function(data) {
                alert("Document supprim√© !");
                location.reload(); // Reload page or update the list dynamically
            },
            error: function(xhr, status, error) {
                alert("Error");
            }
        });
    }
});


    // Handle document edit, implement as needed...
});

window.downloadChecklistItemsGroupedBreuvagePDF = function() {
  const specialCategories = ["ALCOOL FORT", "BIERES", "SANS ALCOOL", "VINS"];

  // La variable categories doit contenir toutes les cat√©gories et leurs items
  const categories = [
    {% for cat_name, items in checklist_items_by_category.items %}
      {% if cat_name in special_categories %}
      {
        name: "{{ cat_name|escapejs }}",
        items: [
          {% for item in items %}
          {
            name: "{{ item.product.name|escapejs }}",
            quantity: "{{ item.quantity }}",
            commentaire: "{{ item.commentaire|escapejs }}",
          },
          {% endfor %}
        ]
      },
      {% endif %}
    {% endfor %}
  ];

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  let cursorY = 20;

  // R√©cup√©rer les infos du checklist
  const checklistName = "{{ checklist.name|escapejs }}";
  const checklistNumContrat = "{{ checklist.num_contrat|escapejs }}";
  const checklistDate = "{{ checklist.date|date:'d/m/Y' }}";
  const checklistMd = "{{ checklist.md|escapejs }}";
  const checklistConseiller = "{{ checklist.conseillere|escapejs }}";

  // Style g√©n√©ral pour la section info
  pdf.setTextColor(0, 102, 204); // Bleu clair
  pdf.setFontSize(16);
  pdf.setFont(undefined, 'bold');
  pdf.text(`Checklist: ${checklistName}`, pageWidth / 2, cursorY, { align: 'center' });
  cursorY += 8;

  pdf.setFontSize(12);
  pdf.setFont(undefined, '');
  // Infos en style avec titres en gras
  function drawInfo(label, value) {
    pdf.setFont(undefined, 'bold');
    pdf.text(`${label}: `, 20, cursorY);
    pdf.setFont(undefined, '');
    pdf.text(`${value}`, 60, cursorY);
    cursorY += 6;
  }
  
  drawInfo('Num√©ro contrat', checklistNumContrat);
  drawInfo('Date', checklistDate);
  drawInfo('MD', checklistMd);
  drawInfo('Conseiller', checklistConseiller);

  cursorY += 4; // l√©g√®rement espac√©

  // Reset couleurs pour le reste
  pdf.setTextColor(0, 0, 0);

  // Parcours des cat√©gories filtr√©es (sp√©ciales uniquement)
  for (const category of categories) {
    // Nom de la cat√©gorie
    pdf.setFontSize(14);
    pdf.setFont(undefined, 'bold');
    pdf.text(category.name, pageWidth / 2, cursorY, { align: 'center' });
    cursorY += 8;

    // Donn√©es du tableau
    const tableData = category.items.map(i => [i.name, i.quantity, i.commentaire]);

    const estimatedHeight = (tableData.length + 1) * 10;
    if (cursorY + estimatedHeight > pageHeight - 10) {
      pdf.addPage();
      cursorY = 20;
    }

    // Cr√©er le tableau
    pdf.autoTable({
      head: [['Produit', 'Quantit√©', 'Commentaire']],
      body: tableData,
      startY: cursorY,
      theme: 'grid',
      styles: { halign: 'center' },
      headStyles: { fillColor: [200, 200, 255], fontStyle: 'bold' },
    });

    cursorY = pdf.lastAutoTable.finalY + 10;
  }

  // Enregistrer
  const filename = `Breuvages_${checklistName.replace(/\s+/g, '_')}.pdf`;
  pdf.save(filename);
};


window.downloadChecklistItemsGroupedPDF = function() {
  const specialCategories = ["ALCOOL FORT", "BIERES", "SANS ALCOOL", "VINS"];

  const categories = [
    {% for cat_name, items in checklist_items_by_category.items %}
      {% if cat_name not in special_categories and cat_name != "CFCDN" and cat_name != "SOUMISSIONS"%}
      {
        name: "{{ cat_name|escapejs }}",
        items: [
          {% for item in items %}
          {
            name: "{{ item.product.name|escapejs }}",
            quantity: "{{ item.quantity }}",
            commentaire: "{{ item.commentaire|escapejs }}",
          },
          {% endfor %}
        ]
      },
      {% endif %}
    {% endfor %}
  ];

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  let cursorY = 20;

  // R√©cup√©rer les infos du checklist
  const checklistName = "{{ checklist.name|escapejs }}";
  const checklistNumContrat = "{{ checklist.num_contrat|escapejs }}";
  const checklistDate = "{{ checklist.date|date:'d/m/Y' }}";
  const checklistMd = "{{ checklist.md|escapejs }}";
  const checklistConseiller = "{{ checklist.conseillere|escapejs }}";

  // Style g√©n√©ral pour la section info
  pdf.setTextColor(0, 102, 204); // Bleu clair
  pdf.setFontSize(16);
  pdf.setFont(undefined, 'bold');
  pdf.text(`Checklist: ${checklistName}`, pageWidth / 2, cursorY, { align: 'center' });
  cursorY += 8;

  pdf.setFontSize(12);
  pdf.setFont(undefined, '');
  // Infos en style avec titres en gras
  function drawInfo(label, value) {
    pdf.setFont(undefined, 'bold');
    pdf.text(`${label}: `, 20, cursorY);
    pdf.setFont(undefined, '');
    pdf.text(`${value}`, 60, cursorY);
    cursorY += 6;
  }
  
  drawInfo('Num√©ro contrat', checklistNumContrat);
  drawInfo('Date', checklistDate);
  drawInfo('MD', checklistMd);
  drawInfo('Conseiller', checklistConseiller);

  cursorY += 4; // l√©g√®rement espac√©

  // Reset colors pour le reste
  pdf.setTextColor(0, 0, 0);

  // Parcours des cat√©gories
  for (const category of categories) {
    if (specialCategories.includes(category.name)) continue;

    // Nom de la cat√©gorie
    pdf.setFontSize(14);
    pdf.setFont(undefined, 'bold');
    pdf.text(category.name, pageWidth / 2, cursorY, { align: 'center' });
    cursorY += 8;

    // Donn√©es du tableau
    const tableData = category.items.map(i => [i.name, i.quantity, i.commentaire]);

    const estimatedHeight = (tableData.length + 1) * 10;
    if (cursorY + estimatedHeight > pageHeight - 10) {
      pdf.addPage();
      cursorY = 20;
    }

    // Cr√©er le tableau
    pdf.autoTable({
      head: [['Produit', 'Quantit√©', 'Commentaire']],
      body: tableData,
      startY: cursorY,
      theme: 'grid',
      styles: { halign: 'center' },
      headStyles: { fillColor: [200, 200, 255], fontStyle: 'bold' },
    });

    cursorY = pdf.lastAutoTable.finalY + 10;
  }

  // Enregistrement
  const filename = `Produits_${checklistName.replace(/\s+/g, '_')}.pdf`;
  pdf.save(filename);
};




window.generatePDFbreuvage = function() {
    // Getting the necessary data from Django
    const checklistName = "{{ checklist.name }}"; // Get checklist name
    const checklistDate = "{{ checklist.date|date:'d F Y' }}"; // Get date
    const conseiller = "{{ checklist.conseillere }}"; // Get conseiller
    const md = "{{ checklist.md }}";

    // Create a new jsPDF instance
    const { jsPDF } = window.jspdf; // Ensure you access jsPDF correctly
    const pdf = new jsPDF();

    // Adding checklist info at the top of the PDF
    pdf.setFontSize(12);
    pdf.text(20, 20, `RAPPORT BREUVAGE - ${checklistName}`);
    pdf.text(20, 30, `${checklistDate}`);
    pdf.text(20, 40, `MD: ${md}`);

    // Use autoTable to create a table dynamically
    const breuvagesData = [
        {% for breuvage in breuvages %}
            ['{{ breuvage.product.name }}', {{ breuvage.quantity }},{{ breuvage.consumed_quantity }}, {{ breuvage.quantity|subtract:breuvage.consumed_quantity }}],
        {% endfor %}
    ];
    pdf.autoTable({
        head: [['Boissons', 'Total', 'Restant', 'Consomm√©']],
        body: breuvagesData,
        startY: 50, // Start position for the table
        theme: 'striped', // Giving it a striped theme
    });

    // Save the PDF
    pdf.save(`rapport_breuvage_${checklistName.replace(/\s+/g, '_')}_${checklistDate}.pdf`);
};

document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetSelector = btn.getAttribute('data-target');
      const target = document.querySelector(targetSelector);
      
      // Toggle collapse avec animation Bootstrap
      const bsCollapse = new bootstrap.Collapse(target, { toggle: true });
      
      // Changer l'ic√¥ne
      const icon = btn.querySelector('.toggle-icon');
      if (target.classList.contains('show')) {
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
      } else {
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
      }
    });
  });

  // Assuming you have access to the breuvages data
// Build an array of special categories items


// When clicking button, generate table
// Wait for the DOM to fully load
document.addEventListener('DOMContentLoaded', () => {
  const showSpecialItemsBtn = document.getElementById('showSpecialItemsBtn');

  if (showSpecialItemsBtn) {
    showSpecialItemsBtn.addEventListener('click', () => {
      const container = document.getElementById('specialItemsContent');

      // Prepare categories array as in your template (simulate with server variable)
      const specialCategories = ["ALCOOL FORT", "BIERES", "SANS ALCOOL", "VINS"];

      // Build the categories array from your existing data
      // Note: this script depends on your backend injecting the data
      const categories = [
        {% for cat_name, items in checklist_items_by_category.items %}
          {% if cat_name in special_categories %}
            {
              name: "{{ cat_name|escapejs }}",
              items: [
                {% for item in items %}
                  {
                    productName: "{{ item.product.name|escapejs }}",
                    quantity: "{{ item.quantity }}",
                    commentaire: "{{ item.commentaire|escapejs }}",
                    status: "{{ item.status|default:'-' }}",
                  }{% if not forloop.last %},{% endif %}
                {% endfor %}
              ]
            }{% if not forloop.last %},{% endif %}
          {% endif %}
        {% endfor %}
      ];

      // Generate HTML
      let html = '';

      categories.forEach(category => {
        html += `<h4 class="mt-3">${category.name}</h4>`;
        html += `<table class="table table-bordered table-striped">
                   <thead><tr>
                     <th>Produit</th>
                     <th>Quantit√©</th>
                     <th>Commentaire</th>
                     <th>Statut</th>
                   </tr></thead><tbody>`;
        category.items.forEach(item => {
          html += `<tr>
            <td>${item.productName}</td>
            <td>${item.quantity}</td>
            <td>${item.commentaire}</td>
            <td>${item.status}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
      });

      // Inject into modal content container
      container.innerHTML = html;
    });
  } else {
    console.warn('Button #showSpecialItemsBtn not found in DOM.');
  }
});

function updateItemComment(checklistItemId, comment) {
    if (!checklistItemId || isNaN(checklistItemId)) {
        console.log("Pas d'ID valide pour cet item");
        return;
    }
    
    fetch(`/update_checklist_item_comment/${checklistItemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ commentaire: comment })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'ok') {
            const item = cart.find(i => i.id === checklistItemId);
            if (item) {
                item.commentaire = comment;
            }
        }
    });
}
</script>
{% endblock %}
