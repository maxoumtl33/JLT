<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Free Kick Master Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #000;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height pour mobiles modernes */
            position: fixed;
            width: 100vw;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 40%, #90EE90 100%);
        }

        /* Header ultra compact */
        .game-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 8px;
            padding-top: max(6px, env(safe-area-inset-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            flex-shrink: 0;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .player-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: gold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .player-name {
            color: white;
            font-size: 13px;
            font-weight: bold;
        }

        .currency {
            display: flex;
            gap: 8px;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: white;
            font-weight: bold;
            font-size: 13px;
        }

        /* Zone de jeu */
        .game-canvas {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0; /* Important pour flex */
        }

        /* Terrain */
        .stadium {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #6FCC6F 0%, #5FAF5F 100%);
        }

        .stadium::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(
                0deg,
                rgba(255,255,255,0.1) 0px,
                transparent 2px,
                transparent 48px,
                rgba(255,255,255,0.1) 50px
            );
        }

        /* Cage de but ajust√©e */
        .goal-container {
            position: absolute;
            top: 6%;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 180px;
            z-index: 2;
        }

        .goal {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .goal-frame {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 5px solid white;
            border-radius: 3px;
            background: rgba(0,0,0,0.1);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }

        .goal-net {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(0deg,
                    rgba(200,200,200,0.2) 0px,
                    transparent 2px,
                    transparent 13px,
                    rgba(200,200,200,0.2) 15px),
                repeating-linear-gradient(90deg,
                    rgba(200,200,200,0.2) 0px,
                    transparent 2px,
                    transparent 13px,
                    rgba(200,200,200,0.2) 15px);
        }

        /* Cibles r√©duites */
        .target {
            position: absolute;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            z-index: 3;
            border: 2px solid white;
            transition: all 0.3s ease;
        }

        .target:nth-child(1) {
            background: linear-gradient(135deg, #FF6B6B, #FF4444);
            top: 10%;
            left: 10%;
        }
        .target:nth-child(2) {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            top: 10%;
            right: 10%;
        }
        .target:nth-child(3) {
            background: linear-gradient(135deg, #667eea, #764ba2);
            bottom: 15%;
            left: 15%;
        }
        .target:nth-child(4) {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            bottom: 15%;
            right: 15%;
        }
        .target:nth-child(5) {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            top: 40%;
            left: 42%;
        }

        .target.moving {
            animation: moveTarget 2s ease-in-out infinite;
        }

        @keyframes moveTarget {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(20px); }
        }

        .target.hit {
            animation: targetHit 0.6s forwards;
        }

        @keyframes targetHit {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.3) rotate(180deg); opacity: 0.5; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        /* Joueur - position dynamique */
        .player {
            position: absolute;
            bottom: 60px;
            left: 50%;
            width: 130px;
            height: 160px;
            z-index: 4;
            transform: translateX(-50%);
            transition: left 0.3s ease;
        }

        .player-sprite {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .player-sprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center bottom;
        }

        .player.kicking .player-sprite {
            animation: playerKick 0.5s ease-out;
        }

        @keyframes playerKick {
            0% { transform: rotate(0deg); }
            30% { transform: rotate(-15deg) translateY(-5px); }
            100% { transform: rotate(0deg); }
        }

        /* Ballon - position dynamique */
        .ball {
            position: absolute;
            bottom: 60px;
            left: 50%;
            width: 25px;
            height: 25px;
            transform: translateX(-50%);
            background: radial-gradient(circle at 30% 30%, white 20%, #ddd 40%, #333 80%);
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            z-index: 10;
            background-size: cover;
            background-position: center;
            transition: left 0.3s ease;
        }

        /* Gardien r√©duit */
        .goalkeeper {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            width: 45px;
            height: 60px;
            transition: left 0.5s ease;
            z-index: 3;
        }

        .goalkeeper-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #FFD700, #FFA500);
            border-radius: 22px 22px 5px 5px;
            position: relative;
        }

        .goalkeeper-body::before {
            content: 'üß§';
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
        }

        /* Contr√¥les - hauteur fixe et toujours visibles */
        .game-controls {
            position: relative;
            height: 110px;
            background: rgba(0, 0, 0, 0.9);
            padding: 5px 6px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            flex-shrink: 0;
        }

        .controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 5px;
            height: 100%;
            justify-content: space-between;
        }

        /* Angle et puissance sur la m√™me ligne */
        .control-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .angle-control, .power-control {
            flex: 1;
        }

        .control-label {
            color: white;
            font-size: 9px;
            margin-bottom: 2px;
            text-align: center;
            text-transform: uppercase;
            opacity: 0.8;
        }

        /* Slider d'angle ultra compact */
        .angle-slider {
            position: relative;
            height: 26px;
            background: linear-gradient(90deg, #3498db 0%, #2ecc71 50%, #3498db 100%);
            border-radius: 13px;
        }

        .angle-handle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Barre de puissance ultra compacte */
        .power-bar {
            height: 26px;
            background: #1a1a1a;
            border-radius: 13px;
            overflow: hidden;
            position: relative;
        }

        .power-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #2ecc71 0%, #f1c40f 50%, #e74c3c 100%);
            transition: width 0.02s linear;
        }

        .power-text {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        /* Bouton de tir ultra compact */
        .shoot-button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #FF6B6B, #FF4444);
            color: white;
            font-size: 15px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
        }

        .shoot-button:active {
            transform: scale(0.98);
        }

        /* Score et infos compacts */
        .score-display {
            position: absolute;
            top: 5px;
            left: 8px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            z-index: 50;
        }

        .score-value {
            font-size: 20px;
            font-weight: bold;
            color: gold;
        }

        .lives-display {
            position: absolute;
            top: 5px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            z-index: 50;
        }

        /* Popup de score */
        .score-popup {
            position: absolute;
            font-size: 22px;
            font-weight: bold;
            color: gold;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: scorePopup 1.2s forwards;
            z-index: 1000;
        }

        @keyframes scorePopup {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }

        /* Game Over ajust√© */
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            color: white;
            z-index: 1000;
            display: none;
            width: 90%;
            max-width: 320px;
        }

        .game-over h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #ff4444;
        }

        .game-over p {
            font-size: 18px;
            margin: 4px 0;
        }

        .gains-section {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }

        .gains-section h3 {
            color: gold;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .restart-button {
            padding: 10px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
        }

        /* Experience popup */
        .exp-popup {
            position: absolute;
            font-size: 18px;
            font-weight: bold;
            color: #4ECDC4;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: expPopup 1.5s forwards;
            z-index: 1000;
        }

        @keyframes expPopup {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-35px) scale(1.1); opacity: 0; }
        }

        /* Fix Safari iOS height */
        @supports (-webkit-touch-callout: none) {
            .game-container {
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <div class="game-header">
            <div class="player-info" onclick="goToHome()">
                <div class="player-avatar">‚öΩ</div>
                <div class="player-name" id="playerName">Chargement...</div>
            </div>
            <div class="currency">
                <div class="currency-item">
                    <span>ü™ô</span>
                    <span id="coins">0</span>
                </div>
                <div class="currency-item">
                    <span>üíé</span>
                    <span id="gems">0</span>
                </div>
            </div>
        </div>

        <!-- Zone de jeu -->
        <div class="game-canvas" id="gameCanvas">
            <div class="stadium"></div>

            <!-- Cage de but -->
            <div class="goal-container">
                <div class="goal" id="goal">
                    <div class="goal-net"></div>
                    <div class="goal-frame"></div>
                    <!-- Les cibles seront ajout√©es ici -->
                </div>
            </div>

            <!-- Gardien -->
            <div class="goalkeeper" id="goalkeeper">
                <div class="goalkeeper-body"></div>
            </div>

            <!-- Joueur -->
            <div class="player" id="player">
                <div class="player-sprite"></div>
            </div>

            <!-- Ballon -->
            <div class="ball" id="ball"></div>

            <!-- Score -->
            <div class="score-display">
                <div style="font-size: 10px;">SCORE</div>
                <div class="score-value" id="score">0</div>
            </div>

            <!-- Vies -->
            <div class="lives-display">
                ‚ù§Ô∏è <span id="lives">3</span>
            </div>

            <!-- Game Over am√©lior√© -->
            <div class="game-over" id="gameOver">
                <h2>GAME OVER!</h2>
                <p>Score Final: <span id="finalScore">0</span></p>

                <div class="gains-section">
                    <h3>Gains de la partie</h3>
                    <p style="font-size: 16px; margin: 4px 0;">
                        ü™ô Coins: <span id="coinsEarned" style="color: gold;">0</span>
                    </p>
                    <p style="font-size: 16px; margin: 4px 0;">
                        üíé Gems: <span id="gemsEarned" style="color: cyan;">0</span>
                    </p>
                    <p style="font-size: 16px; margin: 4px 0;">
                        ‚≠ê Exp: <span id="expEarned" style="color: #4ECDC4;">0</span>
                    </p>
                </div>

                <button class="restart-button" onclick="restartGame()">REJOUER</button>
            </div>
        </div>

        <!-- Contr√¥les -->
        <div class="game-controls">
            <div class="controls-wrapper">
                <div class="control-row">
                    <div class="angle-control">
                        <div class="control-label">Courbe</div>
                        <div class="angle-slider" id="angleSlider">
                            <div class="angle-handle" id="angleHandle">‚ÜîÔ∏è</div>
                        </div>
                    </div>

                    <div class="power-control">
                        <div class="control-label">Puissance</div>
                        <div class="power-bar" id="powerBar">
                            <div class="power-fill" id="powerFill"></div>
                            <div class="power-text" id="powerText">0%</div>
                        </div>
                    </div>
                </div>

                <button class="shoot-button" id="shootButton">‚öΩ TIRER !</button>
            </div>
        </div>
    </div>

    <script>
        // √âtat du jeu
        let gameState = {
            score: 0,
            lives: 3,
            misses: 0,
            currentAngle: 0,
            currentPower: 0,
            isPowerCharging: false,
            powerDirection: 1,
            isShootingEnabled: true,
            baseCoins: 500,
            baseGems: 0,
            sessionCoins: 0,
            sessionGems: 0,
            sessionExp: 0,
            gameOver: false,
            targetSpeed: 0,
            username: 'Joueur',
            successStreak: 0,
            characterStats: {
                power: 50,
                precision: 50,
                luck: 50,
                curve: 50
            },
            totalShots: 0,
            successfulShots: 0,
            targetsHit: 0,
            perfectShots: 0,
            maxCombo: 1,
            currentCombo: 1,
            // Positions de tir m√©moris√©es pour le calcul
            playerPosition: 50,
            ballInitialPosition: 50
        };

        // Fonction pour positionner al√©atoirement le joueur et le ballon
        function randomizePlayerPosition() {
            const player = document.getElementById('player');
            const ball = document.getElementById('ball');
            
            // Zone de tir al√©atoire : entre 30% et 70% de la largeur de l'√©cran
            const minPosition = 30;
            const maxPosition = 70;
            const randomPosition = minPosition + Math.random() * (maxPosition - minPosition);
            
            // M√©moriser la position pour les calculs de tir
            gameState.playerPosition = randomPosition;
            gameState.ballInitialPosition = randomPosition - 3; // Ballon l√©g√®rement √† gauche du joueur
            
            // Positionner le joueur
            player.style.left = `${randomPosition}%`;
            
            // Positionner le ballon (l√©g√®rement √† gauche du joueur)
            ball.style.left = `${gameState.ballInitialPosition}%`;
        }

        // Charger le profil depuis le serveur
        function loadUserProfile() {
            console.log('Chargement du profil utilisateur...');

            fetch('/api/profile/')
                .then(response => {
                    console.log('R√©ponse re√ßue:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Donn√©es du profil:', data);

                    if (data.success) {
                        gameState.username = data.username || 'Joueur';
                        document.getElementById('playerName').textContent = gameState.username;

                        gameState.baseCoins = data.coins !== undefined ? data.coins : 500;
                        gameState.baseGems = data.gems || 0;

                        document.getElementById('coins').textContent = gameState.baseCoins;
                        document.getElementById('gems').textContent = gameState.baseGems;

                        if (data.selected_character) {
                            gameState.characterStats.power = data.selected_character.power || 50;
                            gameState.characterStats.precision = data.selected_character.precision || 50;
                            gameState.characterStats.luck = data.selected_character.luck || 50;
                            gameState.characterStats.curve = data.selected_character.curve || 50;
                        }

                        let playerImageUrl = null;
                        const characterId = data.selected_character_id;
                        let skinBelongsToCharacter = false;

                        if (data.selected_player_skin_image && characterId) {
                            const skinUrl = data.selected_player_skin_image;
                            const skinToCharacterMap = {
                                '/media/player_skins/liftapp_4.png': 1,
                                '/media/player_skins/liftapp_5.png': 2,
                            };

                            const expectedCharacterId = skinToCharacterMap[skinUrl];
                            skinBelongsToCharacter = (expectedCharacterId === characterId);
                        }

                        if (skinBelongsToCharacter && data.selected_player_skin_image) {
                            playerImageUrl = data.selected_player_skin_image;
                        } else {
                            playerImageUrl = data.selected_character_image;
                        }

                        if (playerImageUrl) {
                            loadPlayerImage(playerImageUrl);
                        } else {
                            loadPlayerImage(null);
                        }

                        let ballImageUrl = data.selected_ball_skin_image || data.ball_skin_image || null;

                        if (ballImageUrl) {
                            loadBallSkin(ballImageUrl);
                        }
                    } else {
                        console.error('Erreur dans la r√©ponse:', data.error);
                        document.getElementById('playerName').textContent = 'Joueur';
                        document.getElementById('coins').textContent = '500';
                        document.getElementById('gems').textContent = '0';
                        loadPlayerImage(null);
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du profil:', error);
                    document.getElementById('playerName').textContent = 'Joueur';
                    document.getElementById('coins').textContent = '500';
                    document.getElementById('gems').textContent = '0';
                    loadPlayerImage(null);
                });
        }

        // Charger l'image du joueur
        function loadPlayerImage(imageUrl) {
            const playerSprite = document.querySelector('.player-sprite');

            if (imageUrl) {
                const img = new Image();
                img.onload = function() {
                    playerSprite.innerHTML = '';
                    const playerImg = document.createElement('img');
                    playerImg.src = imageUrl;
                    playerImg.style.width = '100%';
                    playerImg.style.height = '100%';
                    playerImg.style.objectFit = 'contain';
                    playerImg.style.objectPosition = 'center bottom';
                    playerSprite.appendChild(playerImg);
                };
                img.onerror = function() {
                    loadDefaultPlayerImage();
                };
                img.src = imageUrl;
            } else {
                loadDefaultPlayerImage();
            }
        }

        // Charger l'image par d√©faut du joueur
        function loadDefaultPlayerImage() {
            const playerSprite = document.querySelector('.player-sprite');
            playerSprite.innerHTML = '';

            const initial = gameState.username ? gameState.username.charAt(0).toUpperCase() : "J";
            const svgElement = document.createElement('div');
            svgElement.style.width = '100%';
            svgElement.style.height = '100%';
            svgElement.style.backgroundImage = `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 80"><defs><linearGradient id="shirt" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%23FF4444;stop-opacity:1" /><stop offset="100%" style="stop-color:%23CC0000;stop-opacity:1" /></linearGradient></defs><circle cx="30" cy="15" r="10" fill="%23FFD4B2"/><rect x="20" y="25" width="20" height="25" fill="url(%23shirt)" rx="3"/><text x="30" y="40" text-anchor="middle" fill="white" font-size="12" font-weight="bold">${initial}</text><rect x="20" y="50" width="8" height="20" fill="%23333" rx="2"/><rect x="32" y="50" width="8" height="20" fill="%23333" rx="2"/><circle cx="24" cy="70" r="5" fill="%23000"/><circle cx="36" cy="70" r="5" fill="%23000"/></svg>')`;
            svgElement.style.backgroundSize = 'contain';
            svgElement.style.backgroundRepeat = 'no-repeat';
            svgElement.style.backgroundPosition = 'center bottom';
            playerSprite.appendChild(svgElement);
        }

        // Charger le skin de ballon
        function loadBallSkin(imageUrl) {
            const ball = document.getElementById('ball');

            if (imageUrl) {
                const img = new Image();
                img.onload = function() {
                    ball.style.background = 'none';
                    ball.style.width = '25px';
                    ball.style.height = '25px';
                    ball.style.backgroundImage = `url('${imageUrl}')`;
                    ball.style.backgroundSize = '50px 50px';
                    ball.style.backgroundPosition = 'center';
                    ball.style.backgroundRepeat = 'no-repeat';
                    ball.style.borderRadius = '50%';
                    ball.style.transform = 'translateX(-50%) scale(1.8)';
                };
                img.onerror = function() {
                    resetBallToDefault();
                };
                img.src = imageUrl;
            } else {
                resetBallToDefault();
            }
        }

        // R√©initialiser le ballon au style par d√©faut
        function resetBallToDefault() {
            const ball = document.getElementById('ball');
            ball.style.width = '25px';
            ball.style.height = '25px';
            ball.style.backgroundImage = 'none';
            ball.style.background = 'radial-gradient(circle at 30% 30%, white 20%, #ddd 40%, #333 80%)';
            ball.style.borderRadius = '50%';
            ball.style.transform = 'translateX(-50%)';
        }

        // Retour √† l'accueil
        function goToHome() {
            window.location.href = '/homegame/';
        }

        // Cr√©er les cibles
        function createTargets() {
            const goal = document.getElementById('goal');
            const existingTargets = goal.querySelectorAll('.target');
            existingTargets.forEach(t => t.remove());

            const possiblePoints = [20, 30, 40, 50, 75, 100];

            for (let i = 0; i < 5; i++) {
                const target = document.createElement('div');
                target.className = 'target';
                const randomPoints = possiblePoints[Math.floor(Math.random() * possiblePoints.length)];
                target.textContent = randomPoints;
                target.dataset.points = randomPoints;
                target.dataset.index = i;

                if (gameState.score > 100) {
                    target.classList.add('moving');
                }

                goal.appendChild(target);
            }
        }

        // R√©g√©n√©rer une cible
        function regenerateTarget(index) {
            setTimeout(() => {
                const possiblePoints = [20, 30, 40, 50, 75, 100];
                const targets = document.querySelectorAll('.target');
                const target = Array.from(targets).find(t => t.dataset.index == index);

                if (target && !target.classList.contains('hit')) {
                    const randomPoints = possiblePoints[Math.floor(Math.random() * possiblePoints.length)];
                    target.textContent = randomPoints;
                    target.dataset.points = randomPoints;

                    const positions = [
                        { top: `${10 + Math.random() * 20}%`, left: `${10 + Math.random() * 15}%` },
                        { top: `${10 + Math.random() * 20}%`, right: `${10 + Math.random() * 15}%` },
                        { bottom: `${10 + Math.random() * 20}%`, left: `${10 + Math.random() * 15}%` },
                        { bottom: `${10 + Math.random() * 20}%`, right: `${10 + Math.random() * 15}%` },
                        { top: `${35 + Math.random() * 20}%`, left: `${35 + Math.random() * 20}%` }
                    ];

                    const newPosition = positions[index] || positions[Math.floor(Math.random() * positions.length)];

                    target.style.top = '';
                    target.style.bottom = '';
                    target.style.left = '';
                    target.style.right = '';

                    Object.keys(newPosition).forEach(key => {
                        target.style[key] = newPosition[key];
                    });

                    target.style.transform = 'scale(0)';
                    target.style.opacity = '0';
                    setTimeout(() => {
                        target.style.transition = 'all 0.5s ease';
                        target.style.transform = 'scale(1)';
                        target.style.opacity = '1';
                    }, 100);
                }
            }, 20000);
        }

        // Mouvement du gardien
        function startGoalkeeperMovement() {
            const goalkeeper = document.getElementById('goalkeeper');
            const goalWidth = 280;
            const keeperWidth = 45;
            const maxPosition = (goalWidth - keeperWidth) / 2;

            if (gameState.score < 1000) {
                const randomInitialPosition = (Math.random() - 0.5) * maxPosition * 2;
                goalkeeper.style.left = `calc(50% + ${randomInitialPosition}px)`;
            }

            setInterval(() => {
                if (!gameState.isShootingEnabled || gameState.gameOver) return;

                if (gameState.score >= 1000) {
                    const randomPosition = (Math.random() - 0.5) * maxPosition * 2;
                    goalkeeper.style.left = `calc(50% + ${randomPosition}px)`;
                }
            }, 1500);
        }

        function repositionGoalkeeper() {
            if (gameState.score < 1000) {
                const goalkeeper = document.getElementById('goalkeeper');
                const goalWidth = 280;
                const keeperWidth = 45;
                const maxPosition = (goalWidth - keeperWidth) / 2;
                const randomPosition = (Math.random() - 0.5) * maxPosition * 2;
                goalkeeper.style.left = `calc(50% + ${randomPosition}px)`;
            }
        }

        // Contr√¥le de l'angle
        function initAngleControl() {
            const slider = document.getElementById('angleSlider');
            const handle = document.getElementById('angleHandle');
            let isDragging = false;

            function updateAngle(clientX) {
                const rect = slider.getBoundingClientRect();
                const x = clientX - rect.left;
                const percentage = Math.max(0, Math.min(1, x / rect.width));

                const curveMultiplier = gameState.characterStats.curve / 100;
                const maxAngle = 30 + (30 * curveMultiplier);
                const angle = (percentage - 0.5) * maxAngle;

                gameState.currentAngle = angle;
                handle.style.left = `${percentage * 100}%`;
            }

            slider.addEventListener('touchstart', (e) => {
                isDragging = true;
                if (e.touches[0]) updateAngle(e.touches[0].clientX);
                e.preventDefault();
            });

            document.addEventListener('touchmove', (e) => {
                if (isDragging && e.touches[0]) {
                    updateAngle(e.touches[0].clientX);
                    e.preventDefault();
                }
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });

            slider.addEventListener('mousedown', () => isDragging = true);
            document.addEventListener('mousemove', (e) => {
                if (isDragging) updateAngle(e.clientX);
            });
            document.addEventListener('mouseup', () => isDragging = false);
        }

        // Contr√¥le de puissance
        function initPowerControl() {
            const shootButton = document.getElementById('shootButton');
            const powerFill = document.getElementById('powerFill');
            const powerText = document.getElementById('powerText');
            let powerInterval;
            let isCharging = false;

            function startPowerCharge(e) {
                e.preventDefault();
                if (!gameState.isShootingEnabled || isCharging || gameState.gameOver) return;

                isCharging = true;
                gameState.isPowerCharging = true;
                gameState.currentPower = 0;
                gameState.powerDirection = 1;

                powerInterval = setInterval(() => {
                    gameState.currentPower += gameState.powerDirection * 3;

                    if (gameState.currentPower >= 100) {
                        gameState.currentPower = 100;
                        gameState.powerDirection = -1;
                    } else if (gameState.currentPower <= 0) {
                        gameState.currentPower = 0;
                        gameState.powerDirection = 1;
                    }

                    powerFill.style.width = `${gameState.currentPower}%`;
                    powerText.textContent = `${Math.round(gameState.currentPower)}%`;
                }, 20);
            }

            function shoot(e) {
                e.preventDefault();
                if (!gameState.isPowerCharging || !gameState.isShootingEnabled) return;

                clearInterval(powerInterval);
                gameState.isPowerCharging = false;
                isCharging = false;

                performShot();

                setTimeout(() => {
                    powerFill.style.width = '0%';
                    powerText.textContent = '0%';
                }, 500);
            }

            shootButton.addEventListener('touchstart', startPowerCharge);
            shootButton.addEventListener('touchend', shoot);
            shootButton.addEventListener('mousedown', startPowerCharge);
            shootButton.addEventListener('mouseup', shoot);
            shootButton.addEventListener('mouseleave', () => {
                if (isCharging) {
                    clearInterval(powerInterval);
                    gameState.isPowerCharging = false;
                    isCharging = false;
                    powerFill.style.width = '0%';
                    powerText.textContent = '0%';
                }
            });
        }

        // Afficher popup d'exp√©rience
        function showExpPopup(exp, x, y) {
            const popup = document.createElement('div');
            popup.className = 'exp-popup';
            popup.textContent = `+${exp} EXP`;
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;

            document.getElementById('gameCanvas').appendChild(popup);

            setTimeout(() => popup.remove(), 1500);
        }

        // Effectuer le tir (fonction mise √† jour)
        function performShot() {
            if (gameState.gameOver) return;

            gameState.isShootingEnabled = false;
            gameState.totalShots++;

            const ball = document.getElementById('ball');
            const player = document.getElementById('player');

            player.classList.add('kicking');
            setTimeout(() => player.classList.remove('kicking'), 500);

            // R√©duction de puissance de 30%
            const powerMultiplier = 0.7 * (1.1 + (gameState.characterStats.power / 100) * 0.4);
            const power = (gameState.currentPower / 100) * powerMultiplier;

            const precisionModifier = (100 - gameState.characterStats.precision) / 200;
            const randomOffset = (Math.random() - 0.5) * 10 * precisionModifier;

            const angle = gameState.currentAngle + randomOffset;

            const duration = 800;
            const startTime = Date.now();
            const startBottom = 60;
            const startLeft = gameState.ballInitialPosition; // Utiliser la position al√©atoire

            const targetBottom = 250 + (power * 350);
            const targetLeft = 50 + (angle * 2.5);

            const isLuckyShot = Math.random() * 100 < gameState.characterStats.luck;

            function animateBall() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);

                const heightProgress = 1 - Math.pow(1 - progress, 2);
                const lateralProgress = progress;
                const curveEffect = Math.sin(progress * Math.PI * 0.5) * angle * 0.5;

                const currentBottom = startBottom + (targetBottom - startBottom) * heightProgress;
                const currentLeft = startLeft + (targetLeft - startLeft) * lateralProgress + curveEffect;

                const ballXPixels = (currentLeft / 100) * document.getElementById('gameCanvas').getBoundingClientRect().width;
                const ballYPixels = document.getElementById('gameCanvas').getBoundingClientRect().height - currentBottom;

                const goalkeeper = document.getElementById('goalkeeper');
                const keeperRect = goalkeeper.getBoundingClientRect();
                const canvasRect = document.getElementById('gameCanvas').getBoundingClientRect();

                if (ballXPixels >= keeperRect.left - canvasRect.left &&
                    ballXPixels <= keeperRect.right - canvasRect.left &&
                    ballYPixels >= keeperRect.top - canvasRect.top &&
                    ballYPixels <= keeperRect.bottom - canvasRect.top) {

                    if (isLuckyShot) {
                        showScorePopup('üçÄ TIR CHANCEUX!', canvasRect.width/2, keeperRect.top - canvasRect.top - 50);
                    } else {
                        const keeperCenterX = (keeperRect.left + keeperRect.width/2 - canvasRect.left) / canvasRect.width * 100;
                        const keeperCenterY = canvasRect.height - (keeperRect.top + keeperRect.height/2 - canvasRect.top);

                        ball.style.transition = 'all 0.2s ease-out';
                        ball.style.left = `${keeperCenterX}%`;
                        ball.style.bottom = `${keeperCenterY}px`;
                        ball.style.transform = 'translateX(-50%) scale(1.2)';

                        setTimeout(() => {
                            ball.style.transform = 'translateX(-50%) scale(0.8) rotate(90deg)';
                        }, 200);

                        setTimeout(() => {
                            ball.style.bottom = `${keeperCenterY - 60}px`;
                            ball.style.transform = 'translateX(-50%) scale(0.6) rotate(180deg)';
                        }, 400);

                        gameState.misses++;
                        gameState.lives--;
                        gameState.successStreak = 0;
                        document.getElementById('lives').textContent = gameState.lives;
                        showScorePopup('ARR√äT! üß§', canvasRect.width/2, keeperRect.top - canvasRect.top);

                        setTimeout(() => {
                            resetBallPosition();
                            gameState.isShootingEnabled = true;
                            repositionGoalkeeper();
                            randomizePlayerPosition(); // Nouvelle position al√©atoire
                        }, 1200);

                        if (gameState.lives <= 0) {
                            setTimeout(() => endGame(), 1200);
                        }

                        return;
                    }
                }

                ball.style.bottom = `${currentBottom}px`;
                ball.style.left = `${currentLeft}%`;
                ball.style.transform = `translateX(-50%) rotate(${progress * 720}deg) scale(${1 - progress * 0.2})`;

                if (progress < 1) {
                    requestAnimationFrame(animateBall);
                } else {
                    checkShotResult(currentLeft, currentBottom, isLuckyShot);

                    setTimeout(() => {
                        repositionGoalkeeper();
                    }, 100);

                    setTimeout(() => {
                        resetBallPosition();
                        gameState.isShootingEnabled = true;
                        randomizePlayerPosition(); // Nouvelle position al√©atoire apr√®s le tir
                    }, 500);
                }
            }

            animateBall();
        }

        // Fonction pour r√©initialiser la position du ballon
        function resetBallPosition() {
            const ball = document.getElementById('ball');
            ball.style.transition = 'none';
            ball.style.bottom = '60px';
            ball.style.left = `${gameState.ballInitialPosition}%`;
            ball.style.transform = 'translateX(-50%)';
            
            // R√©appliquer le skin de ballon si n√©cessaire
            if (ball.style.backgroundImage && ball.style.backgroundImage !== 'none') {
                ball.style.transform = 'translateX(-50%) scale(1.8)';
            }
        }

        // V√©rifier le r√©sultat du tir
        function checkShotResult(ballX, ballY, isLuckyShot = false) {
            const canvasRect = document.getElementById('gameCanvas').getBoundingClientRect();
            const goalElement = document.querySelector('.goal-container');
            const goalRect = goalElement.getBoundingClientRect();

            const ballXPixels = (ballX / 100) * canvasRect.width;
            const ballYPixels = canvasRect.height - ballY;

            const goalkeeper = document.getElementById('goalkeeper');
            const keeperRect = goalkeeper.getBoundingClientRect();

            let scored = false;
            let points = 0;

            if (ballXPixels >= goalRect.left - canvasRect.left &&
                ballXPixels <= goalRect.right - canvasRect.left &&
                ballYPixels >= goalRect.top - canvasRect.top &&
                ballYPixels <= goalRect.bottom - canvasRect.top) {

                scored = true;
                points = 10;

                if (isLuckyShot) {
                    points += 15;
                    showScorePopup('+15 BONUS!', canvasRect.width/2, 80);
                }

                gameState.successfulShots++;
                gameState.successStreak++;
                gameState.currentCombo++;

                if (gameState.currentCombo > gameState.maxCombo) {
                    gameState.maxCombo = gameState.currentCombo;
                }

                if (gameState.successStreak % 10 === 0) {
                    gameState.sessionExp += 75;
                    showExpPopup(75, canvasRect.width/2, 150);
                }

                const targets = document.querySelectorAll('.target:not(.hit)');
                targets.forEach(target => {
                    const targetRect = target.getBoundingClientRect();
                    const targetCenterX = targetRect.left + targetRect.width/2 - canvasRect.left;
                    const targetCenterY = targetRect.top + targetRect.height/2 - canvasRect.top;

                    const distance = Math.sqrt(
                        Math.pow(ballXPixels - targetCenterX, 2) +
                        Math.pow(ballYPixels - targetCenterY, 2)
                    );

                    if (distance < 30) {
                        target.classList.add('hit');
                        gameState.targetsHit++;
                        const targetPoints = parseInt(target.dataset.points);

                        const precisionBonus = Math.floor(targetPoints * (gameState.characterStats.precision / 200));
                        const totalTargetPoints = targetPoints + precisionBonus;

                        points += totalTargetPoints;
                        showScorePopup(`+${totalTargetPoints}`, targetCenterX, targetCenterY);

                        regenerateTarget(target.dataset.index);
                    }
                });

                const remainingTargets = document.querySelectorAll('.target:not(.hit)');
                if (remainingTargets.length === 0) {
                    setTimeout(() => {
                        createTargets();
                        showScorePopup('üéØ NOUVELLES CIBLES!', canvasRect.width/2, 100);
                    }, 100);
                }

                if (gameState.currentPower >= 60 && gameState.currentPower <= 80) {
                    gameState.perfectShots++;
                }

                updateScore(points);
                gameState.misses = 0;
            } else {
                gameState.misses++;
                gameState.lives--;
                gameState.successStreak = 0;
                gameState.currentCombo = 1;
                document.getElementById('lives').textContent = gameState.lives;
                showScorePopup('RAT√â!', canvasRect.width/2, 200);

                if (gameState.lives <= 0) {
                    endGame();
                }
            }

            if (gameState.score > 100 && gameState.score % 50 === 0) {
                createTargets();
            }
        }

        // Mettre √† jour le score
        function updateScore(points) {
            gameState.score += points;
            document.getElementById('score').textContent = gameState.score;

            gameState.sessionCoins = Math.floor(gameState.score / 10);
            gameState.sessionGems = Math.floor(gameState.score / 500);
        }

        // Afficher popup de score
        function showScorePopup(text, x, y) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = text;
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;

            document.getElementById('gameCanvas').appendChild(popup);

            setTimeout(() => popup.remove(), 1200);
        }

        // Fin du jeu
        function endGame() {
            gameState.gameOver = true;
            gameState.isShootingEnabled = false;

            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('coinsEarned').textContent = gameState.sessionCoins;
            document.getElementById('gemsEarned').textContent = gameState.sessionGems;
            document.getElementById('expEarned').textContent = gameState.sessionExp;
            document.getElementById('gameOver').style.display = 'block';

            setTimeout(() => {
                const newCoinsTotal = gameState.baseCoins + gameState.sessionCoins;
                const newGemsTotal = gameState.baseGems + gameState.sessionGems;

                let currentCoinDisplay = gameState.baseCoins;
                const coinInterval = setInterval(() => {
                    if (currentCoinDisplay < newCoinsTotal) {
                        currentCoinDisplay++;
                        document.getElementById('coins').textContent = currentCoinDisplay;
                    } else {
                        clearInterval(coinInterval);
                    }
                }, 50);

                if (gameState.sessionGems > 0) {
                    let currentGemDisplay = gameState.baseGems;
                    const gemInterval = setInterval(() => {
                        if (currentGemDisplay < newGemsTotal) {
                            currentGemDisplay++;
                            document.getElementById('gems').textContent = currentGemDisplay;
                        } else {
                            clearInterval(gemInterval);
                        }
                    }, 200);
                }
            }, 1000);

            saveGameData();
        }

        // Sauvegarder les donn√©es
        function saveGameData() {
            const coinsEarned = Math.floor(gameState.score / 10);
            const gemsEarned = Math.floor(gameState.score / 500);
            const expEarned = gameState.sessionExp;

            const csrftoken = getCookie('csrftoken');

            fetch('/api/save-score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    score: gameState.score,
                    coins_earned: coinsEarned,
                    gems_earned: gemsEarned,
                    exp_earned: expEarned,
                    total_shots: gameState.totalShots,
                    successful_shots: gameState.successfulShots,
                    targets_hit: gameState.targetsHit,
                    perfect_shots: gameState.perfectShots,
                    max_combo: gameState.maxCombo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Score sauvegard√© avec succ√®s');

                    if (data.total_coins !== undefined) {
                        gameState.baseCoins = data.total_coins;
                        document.getElementById('coins').textContent = gameState.baseCoins;
                    }
                    if (data.total_gems !== undefined) {
                        gameState.baseGems = data.total_gems;
                        document.getElementById('gems').textContent = gameState.baseGems;
                    }

                    if (data.level_up) {
                        showScorePopup(`üéâ NIVEAU ${data.new_level}! üéâ`,
                            document.getElementById('gameCanvas').offsetWidth/2, 100);
                    }
                }
            })
            .catch(error => {
                console.error('Erreur r√©seau:', error);
            });
        }

        // Obtenir le cookie CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Red√©marrer le jeu
        function restartGame() {
            // Recharger les donn√©es du profil
            fetch('/api/profile/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        gameState.baseCoins = data.coins !== undefined ? data.coins : 500;
                        gameState.baseGems = data.gems || 0;
                        document.getElementById('coins').textContent = gameState.baseCoins;
                        document.getElementById('gems').textContent = gameState.baseGems;
                    }

                    // R√©initialiser toutes les variables du jeu
                    gameState.score = 0;
                    gameState.lives = 3;
                    gameState.misses = 0;
                    gameState.currentAngle = 0;
                    gameState.currentPower = 0;
                    gameState.isPowerCharging = false;
                    gameState.powerDirection = 1;
                    gameState.isShootingEnabled = true;
                    gameState.gameOver = false;
                    gameState.targetSpeed = 0;
                    gameState.totalShots = 0;
                    gameState.successfulShots = 0;
                    gameState.targetsHit = 0;
                    gameState.perfectShots = 0;
                    gameState.maxCombo = 1;
                    gameState.currentCombo = 1;
                    gameState.sessionCoins = 0;
                    gameState.sessionGems = 0;
                    gameState.sessionExp = 0;
                    gameState.successStreak = 0;

                    // R√©initialiser l'affichage
                    document.getElementById('score').textContent = '0';
                    document.getElementById('lives').textContent = '3';
                    document.getElementById('gameOver').style.display = 'none';

                    // Positionner al√©atoirement le joueur et le ballon
                    randomizePlayerPosition();

                    // R√©initialiser la position du handle d'angle
                    const angleHandle = document.getElementById('angleHandle');
                    angleHandle.style.left = '50%';

                    // R√©initialiser la barre de puissance
                    document.getElementById('powerFill').style.width = '0%';
                    document.getElementById('powerText').textContent = '0%';

                    // Recr√©er les cibles
                    createTargets();

                    // Repositionner le gardien
                    repositionGoalkeeper();
                })
                .catch(error => {
                    console.error('Erreur lors du rechargement:', error);
                    location.reload();
                });
        }

        // Initialiser le jeu
        function initGame() {
            console.log('Initialisation du jeu...');
            loadUserProfile();
            createTargets();
            startGoalkeeperMovement();
            initAngleControl();
            initPowerControl();
            randomizePlayerPosition(); // Position al√©atoire initiale

            // Emp√™cher le zoom sur iOS
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.addEventListener('gesturechange', (e) => e.preventDefault());
            document.addEventListener('gestureend', (e) => e.preventDefault());
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>