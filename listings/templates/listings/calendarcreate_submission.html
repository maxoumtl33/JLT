{% extends 'listings/base.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}
<link href='https://unpkg.com/@fullcalendar/core@5/main.min.css' rel='stylesheet' />
<script src='https://unpkg.com/@fullcalendar/core@5/main.min.js'></script>
<script src='https://unpkg.com/@fullcalendar/daygrid@5/main.min.js'></script>

<style>
    /* General styling */
    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        color: #333;
        display: flex;
        height: 100vh;
        overflow: hidden;
        transition: background-color 0.3s linear, color 0.3s linear;
    }

    .clickable-row {
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .clickable-row:hover {
        filter: brightness(95%);
    }
    
    h1, h2 {
        color: #343a40;
    }

    /* General page styles */
    .agenda-title {
        font-size: 2rem;
        margin-bottom: 20px;
        text-align: center;
        color: #333;
    }

    /* Month selection styles */
    .month-selection {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
    .month-label {
        font-size: 1rem;
        margin-right: 10px;
        align-self: center;
    }
    .month-dropdown {
        padding: 10px;
        font-size: 1rem;
        border-radius: 5px;
        border: 1px solid #ccc;
        outline: none;
        transition: border-color 0.3s ease;
    }
    .month-dropdown:hover {
        border-color: #007bff;
    }

    /* General layout styling */
    .agenda-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        padding: 20px;
    }

    .notification-container {
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .notification-table th {
        position: relative;
        user-select: none;
        white-space: nowrap;
    }

    .notification-table th:hover {
        background-color: #0056b3 !important;
    }

    .notification-table tbody tr {
        transition: all 0.3s ease;
    }

    .notification-table tbody tr:hover {
        transform: scale(1.01);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .table-danger {
        background-color: #f8d7da !important;
    }

    .table-warning {
        background-color: #fff3cd !important;
    }

    .table-info {
        background-color: #d1ecf1 !important;
    }

    /* Style pour le bouton toggle */
    #toggleNotifBtn {
        transition: all 0.3s ease;
    }

    #toggleNotifBtn:hover {
        transform: scale(1.05);
    }

    /* Animation pour le contenu des notifications */
    #notificationContent {
        transition: all 0.3s ease-in-out;
    }

    .badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9rem;
    }

    /* Calendar section */
    .calendar-section {
        width: 100%;
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-width: 40%;
        transition: width 0.3s ease;
    }

    .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-gap: 10px;
    }
    .day {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .day-btn {
        position: relative;
        padding: 10px;
        font-size: 0.9rem;
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        height: 60px;
        text-align: center;
        transition: background-color 0.3s ease;
    }
    .day-btn:hover {
        background-color: #007bff;
        color: white;
    }

    .daycreate-btn {
        position: relative;
        padding: 10px;
        font-size: 0.9rem;
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        height: 60px;
        text-align: center;
        transition: background-color 0.3s ease;
    }
    .daycreate-btn:hover {
        background-color: #007bff;
        color: white;
    }
    
    .submission-sections {
        width: 100%;
        max-width: 60%;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .submission-table {
        width: 100%;
        border-collapse: collapse;
    }
    .submission-table th, .submission-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    .submission-table th {
        background-color: #007bff;
        color: white;
    }
    .submission-table td a {
        text-decoration: none;
        color: #007bff;
    }
    .submission-table td a:hover {
        text-decoration: underline;
    }

    .submissioncreate-section {
        width: 55%;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .submissioncreate-table {
        width: 100%;
        border-collapse: collapse;
    }
    .submissioncreate-table th, .submissioncreate-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    .submissioncreate-table th {
        background-color: #007bff;
        color: white;
    }
    .submissioncreate-table td a {
        text-decoration: none;
        color: #007bff;
    }
    .submissioncreate-table td a:hover {
        text-decoration: underline;
    }

    /* Selected day button style */
    .day-btn.selected {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        border-color: #0056b3;
    }
    .daycreate-btn.selected {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        border-color: #0056b3;
    }
    .notif-top-right {
        position: absolute;
        right: 5px;
        top: 5px;
        font-size: 0.7rem;
        background-color: orange;
        color: white;
        padding: 3px;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
    }

    .filter-section {
        margin-bottom: 20px;
    }

    .custom-checkbox {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 1rem;
    }

    .custom-checkbox input {
        display: none;
    }

    .custom-checkbox .checkmark {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #007bff;
        border-radius: 4px;
        margin-right: 10px;
        position: relative;
    }

    .custom-checkbox input:checked + .checkmark {
        background-color: #007bff;
    }

    .custom-checkbox input:checked + .checkmark:after {
        content: '';
        position: absolute;
        top: 4px;
        left: 6px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    .sidebar {
        width: 250px;
        background-color: #007BFF;
        height: 100%;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        overflow-y: auto;
    }

    .sidebar .sidebar-header {
        font-size: 24px;
        color: #fff;
        margin-bottom: 20px;
    }

    .aref {
        color: #fff;
        display: block;
        padding: 10px;
        text-decoration: none;
        margin-bottom: 10px;
        border-radius: 8px;
        transition: background-color 0.3s;
    }

    .aref.active, .aref:hover {
        background-color: #0056b3;
        color: #fff;
        text-decoration: none;
    }

    .checklistss {
        flex: 1;
        padding: 20px;
        background-color: #F0F2F5;
        overflow-y: auto;
        transition: margin-left 0.3s ease;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .header .toggle-theme {
        cursor: pointer;
        color: #007BFF;
    }
    
    #checklistss.expanded {
        margin-left: 0;
    }

    #checklistss.full-width {
        transition: margin-left 0s;
    }

    .collapsed {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        width: 0;
    }

    .dark-mode {
        background-color: #121212;
        color: #e4e4e4;
    }

    .dark-mode .header, .dark-mode .card {
        background-color: #1e1e1e;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .dark-mode .sidebar {
        background-color: #1e1e1e;
    }

    .dark-mode .sidebar a {
        color: #e4e4e4;
    }

    .dark-mode .sidebar a.active, .dark-mode .sidebar a:hover {
        background-color: #333;
        color: #fff;
    }

    @media (max-width: 1200px) {
        .agenda-container {
            flex-direction: column;
            align-items: stretch;
        }
        .calendar-section,
        .submission-sections {
            width: 100%;
            max-width: none;
        }
    }

    @media (max-width: 932px) {
        .agenda-container {
            flex-direction: column;
            align-items: stretch;
        }
        .calendar-section,
        .submission-sections {
            width: 100%;
            max-width: none;
        }
    }

    @media (max-width: 768px) {
        .agenda-container {
            flex-direction: column;
            align-items: stretch;
        }
        .calendar,
        .submission-sections {
            width: 100%;
            max-width: none;
        }
        .notification-container {
            padding: 10px;
            margin: 10px;
        }
        .table-responsive {
            font-size: 0.85rem;
        }
    }

    @media (max-width: 480px) {
        .calendar-section {
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }
        .agenda-container {
            align-items: stretch;
        }
        .calendar,
        .submission-sections {
            width: 100%;
            max-width: none;
        }
        .day-btn {
            font-size: 0.7rem;
            height: 28px;
            padding: 4px;
        }
        .agenda-title {
            font-size: 1.5rem;
        }
        .month-dropdown {
            font-size: 0.9rem;
            padding: 8px;
        }
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<div class="sidebar" id="sidebar">
    <div class="sidebar-header" style="margin-top: 100px;">Menu <button class="toggle-sidebar" id="sidebar-toggle"><i class="fas fa-bars"></i></button></div>
    <a href="{% url 'conseiller_dashboard' %}" class="aref"><i class="fa-solid fa-desktop me-2"></i> Tableau de bord</a>
    <a href="{% url 'journees-list' %}" class="aref"><i class="fa-solid fa-truck me-2"></i> Livraisons</a>
    <a href="{% url 'creerchecklist' %}" class="aref"><i class="fas fa-list-check me-2"></i> Checklists</a>
    <a href="{% url 'calendarsub_view' %}" class="aref">
        <i class="fa-solid fa-file-contract me-2"></i>Soumissions
    </a>
    <a href="{% url 'submit_request' %}" target="_blank" class="aref">
        <i class="fa-solid fa-file-signature me-2"></i>Créer Soumission
    </a>
    <a class="aref" href="{% url 'etiquette-tente' %}" class="aref"><i class="fa-solid fa-print me-2"></i>Etiquette tente</a>
    
    {% if user.username == "Audrey" or user.username == "Maxime" or user.username == "Roxanne" %}
    <a href="{% url 'manage_submissions' %}" class="aref">
        <i class="fa-solid fa-file-pdf me-2"></i>PDF et Recherche Soumission
    </a>
    <a href="{% url 'calendarsubcreate_view' %}" class="aref">
        <i class="fa-solid fa-calendar-days me-2"></i>Suivi Soumissions
    </a>
    <a href="#" class="aref" data-bs-toggle="modal" data-bs-target="#createProductModal">
        <i class="fa-solid fa-box me-2"></i>Créer un Produit
    </a>
    {% endif %}
    
    <button class="toggle-theme" id="theme-toggle" style="margin-top:10px;"><i class="fas fa-moon"></i> Thème</button>
    <div style="margin-top:20px; font-size:14px; color:#ccc;">Utilisateur: {{ user.username }}</div>
</div>

<div class="checklistss" id="checklistss">
    <div class="header">
        <h2>CALENDRIER SOUMISSIONS / COMMANDES <strong><u>DATE DE CRÉATION</u></strong></h2>
        <button id="show-sidebar" style="display:none; position: fixed; top: 12%; left: 10px;">
            <i class="fas fa-bars fa-2xl"></i>
        </button>
        <div class="user-info">
            <button id="logoutBtn" style="border:none; background:none; cursor:pointer;"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
        </div>
    </div>
    <br>
    <br>
    <br>
    <br>

    {% if notifications_urgentes.exists or notifications_mois_actuel.exists or notifications_envoyees_48h.exists %}
    <div class="notification-container" style="margin: 20px; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <!-- En-tête avec compteur total et bouton toggle -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #ff6b6b; margin: 0;">
                <i class="fas fa-exclamation-triangle"></i> Notifications - Soumissions Événement
                <span class="badge bg-danger" style="margin-left: 10px;">
                    {{ notifications_urgentes.count|add:notifications_mois_actuel.count|add:notifications_envoyees_48h.count }}
                </span>
            </h3>
            <button class="btn btn-primary" onclick="toggleNotifications()" id="toggleNotifBtn">
                <i class="fas fa-chevron-down" id="toggleIcon"></i> Afficher les notifications
            </button>
        </div>
        
        <!-- Contenu collapsible des notifications -->
        <div id="notificationContent" style="display: none;">
            <!-- Résumé des notifications par catégorie -->
            <div class="row mb-3">
                {% if notifications_urgentes.exists %}
                <div class="col-md-4">
                    <div class="alert alert-danger" role="alert">
                        <strong><i class="fas fa-clock"></i> Urgentes (< 48h) :</strong><br>
                        {{ notifications_urgentes.count }} soumission(s) en cours
                    </div>
                </div>
                {% endif %}
                
                {% if notifications_mois_actuel.exists %}
                <div class="col-md-4">
                    <div class="alert alert-warning" role="alert">
                        <strong><i class="fas fa-calendar-alt"></i> Mois en cours :</strong><br>
                        {{ notifications_mois_actuel.count }} soumission(s) > 48h
                    </div>
                </div>
                {% endif %}
                
                {% if notifications_envoyees_48h.exists %}
                <div class="col-md-4">
                    <div class="alert alert-info" role="alert">
                        <strong><i class="fas fa-paper-plane"></i> Envoyées > 48h :</strong><br>
                        {{ notifications_envoyees_48h.count }} sans réponse
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Tableau des notifications -->
            <div class="table-responsive">
                <table class="table table-hover notification-table" id="notificationTable">
                    <thead style="background-color: #007bff; color: white;">
                        <tr>
                            <th onclick="sortNotificationTable(0)" style="cursor: pointer;">
                                Nom de l'événement <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortNotificationTable(1)" style="cursor: pointer;">
                                Conseillère <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortNotificationTable(2)" style="cursor: pointer;">
                                Nb personnes <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortNotificationTable(3)" style="cursor: pointer;">
                                Créé quand <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortNotificationTable(4)" style="cursor: pointer;">
                                Envoyé quand <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortNotificationTable(5)" style="cursor: pointer;">
                                Date événement <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortNotificationTable(6)" style="cursor: pointer;">
                                Statut <i class="fas fa-sort"></i>
                            </th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Lignes urgentes (moins de 48h) -->
                        {% for sub in notifications_urgentes %}
                        <tr class="table-danger">
                            <td>{{ sub.company_name|default:"N/A" }}</td>
                            <td>{{ sub.user.username|default:"N/A" }}</td>
                            <td>{{ sub.nombre_personnes|default:"N/A" }}</td>
                            <td data-sort="{{ sub.created_at|date:'Y-m-d H:i' }}">
                                {{ sub.created_at|date:"d/m/Y H:i" }}
                            </td>
                            <td data-sort="{{ sub.sent_at|date:'Y-m-d H:i'|default:'9999-12-31' }}">
                                {% if sub.sent_at %}
                                    {{ sub.sent_at|date:"d/m/Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Non envoyé</span>
                                {% endif %}
                            </td>
                            <td data-sort="{{ sub.date|date:'Y-m-d' }}" style="font-weight: bold;">
                                {{ sub.date|date:"d/m/Y" }}
                            </td>
                            <td>
                                <span class="badge bg-danger">Urgent - En cours</span>
                            </td>
                            <td>
                                <a href="{% url 'submission_detail' sub.id %}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Lignes mois actuel (plus de 48h depuis création) -->
                        {% for sub in notifications_mois_actuel %}
                        <tr class="table-warning">
                            <td>{{ sub.company_name|default:"N/A" }}</td>
                            <td>{{ sub.user.username|default:"N/A" }}</td>
                            <td>{{ sub.nombre_personnes|default:"N/A" }}</td>
                            <td data-sort="{{ sub.created_at|date:'Y-m-d H:i' }}">
                                {{ sub.created_at|date:"d/m/Y H:i" }}
                            </td>
                            <td data-sort="{{ sub.sent_at|date:'Y-m-d H:i'|default:'9999-12-31' }}">
                                {% if sub.sent_at %}
                                    {{ sub.sent_at|date:"d/m/Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Non envoyé</span>
                                {% endif %}
                            </td>
                            <td data-sort="{{ sub.date|date:'Y-m-d' }}">
                                {{ sub.date|date:"d/m/Y" }}
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark">En cours > 48h</span>
                            </td>
                            <td>
                                <a href="{% url 'submission_detail' sub.id %}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Lignes envoyées depuis plus de 48h -->
                        {% for sub in notifications_envoyees_48h %}
                        <tr class="table-info">
                            <td>{{ sub.company_name|default:"N/A" }}</td>
                            <td>{{ sub.user.username|default:"N/A" }}</td>
                            <td>{{ sub.nombre_personnes|default:"N/A" }}</td>
                            <td data-sort="{{ sub.created_at|date:'Y-m-d H:i' }}">
                                {{ sub.created_at|date:"d/m/Y H:i" }}
                            </td>
                            <td data-sort="{{ sub.sent_at|date:'Y-m-d H:i'|default:'9999-12-31' }}">
                                {% if sub.sent_at %}
                                    {{ sub.sent_at|date:"d/m/Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Non envoyé</span>
                                {% endif %}
                            </td>
                            <td data-sort="{{ sub.date|date:'Y-m-d' }}">
                                {{ sub.date|date:"d/m/Y" }}
                            </td>
                            <td>
                                <span class="badge bg-info">Envoyé > 48h</span>
                            </td>
                            <td>
                                <a href="{% url 'submission_detail' sub.id %}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="agenda-container">
        <!-- Calendar to get submissions by creation date -->
        <div id="calendar-create-section" class="calendar-section">
            <div class="month-selection">
                <label for="month-create" class="month-label">Sélectionnez le mois :</label>
                <select id="month-create" name="month-create" onchange="updateCreateAgenda()" class="month-dropdown">
                    {% for month_name in french_months %}
                        <option value="{{ forloop.counter0|add:1 }}" {% if forloop.counter0|add:1 == selected_month %}selected{% endif %}>
                            {{ month_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div id="calendar-create" class="calendar">
                <div class="day"><strong>Dim</strong></div>
                <div class="day"><strong>Lun</strong></div>
                <div class="day"><strong>Mar</strong></div>
                <div class="day"><strong>Mer</strong></div>
                <div class="day"><strong>Jeu</strong></div>
                <div class="day"><strong>Ven</strong></div>
                <div class="day"><strong>Sam</strong></div>

                {% for day in days %}
                    <div class="day">
                        <button class="daycreate-btn" data-day="{{ day }}" onclick="getSubmissionsCreate({{ day }})" {% if day == '' %}disabled{% endif %}>
                            {{ day }}
                            {% with daily_counts|get_item:day as counts %}
                                {% if counts and counts.en_cours > 0 %}
                                    <span class="notif-top-right">{{ counts.en_cours }}</span>
                                {% endif %}
                            {% endwith %}
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div id="submissioncreate-section" class="submission-sections">
            <div class="submission-section" style="display: flex;">
                <div class="filter-section">
                    <span style="margin-right: 10px;">Afficher :</span>
                    <label>
                        <input type="radio" name="status-filter" value="all" checked onchange="filterSubmissions()" />
                        Tous
                    </label>
                    <label>
                        <input type="radio" name="status-filter" value="en_cours" onchange="filterSubmissions()" />
                        En cours
                    </label>
                    <label>
                        <input type="radio" name="status-filter" value="valide" onchange="filterSubmissions()" />
                        Validé
                    </label>
                    <label>
                        <input type="radio" name="status-filter" value="refuse" onchange="filterSubmissions()" />
                        Refusé
                    </label>
                    <label>
                        <input type="radio" name="status-filter" value="envoye" onchange="filterSubmissions()" />
                        Envoyé
                    </label>
                </div>
            
                <div class="type-filter-section">
                    <span style="margin-right: 10px;">Type de soumission :</span>
                    <label>
                        <input type="checkbox" name="type-filter" value="Soumission événement" onchange="filterSubmissions()" />
                        Soumission événement
                    </label>
                    <label>
                        <input type="checkbox" name="type-filter" value="Commande événement" onchange="filterSubmissions()" />
                        Commande événement
                    </label>
                    <label>
                        <input type="checkbox" name="type-filter" value="Soumission BAL/Buffet" onchange="filterSubmissions()" />
                        Soumission BAL/Buffet
                    </label>
                    <label>
                        <input type="checkbox" name="type-filter" value="Commande BAL/Buffet" onchange="filterSubmissions()" />
                        Commande BAL/Buffet
                    </label>
                </div>
            </div>
            
            <br>
            <table class="table table-hover submissioncreate-table">
                <thead>
                    <tr>
                        <th data-sort="client" style="cursor: pointer;">Client</th>
                        <th data-sort="type" style="cursor: pointer;">Type</th>
                        <th data-sort="ajoute_par" style="cursor: pointer;">Ajouté par</th>
                        <th data-sort="ajoute_le" style="cursor: pointer;">Ajouté le</th>
                        <th data-sort="date" style="cursor: pointer;">Date</th>
                        <th data-sort="status" style="cursor: pointer;">Status</th>
                    </tr>
                </thead>
                <tbody id="submissioncreate-list" data-detail-url="{% url 'submission_detail' submission_id=0 %}">
                    <!-- Submissions will appear dynamically here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.submissioncreate-table');
    const tbody = table.querySelector('tbody');

    // Function to sort the table rows
    function sortTable(columnIndex, asc = true) {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const sortedRows = rows.sort((a, b) => {
            const aText = a.children[columnIndex].innerText;
            const bText = b.children[columnIndex].innerText;

            // Handle sorting as numbers if the content is numeric
            const aValue = isNaN(aText) ? aText : parseFloat(aText);
            const bValue = isNaN(bText) ? bText : parseFloat(bText);

            return asc ? (aValue > bValue ? 1 : -1) : (aValue < bValue ? 1 : -1);
        });

        // Remove existing rows and append sorted rows
        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
    }

    // Add click event listeners to each header to sort
    table.querySelectorAll('th').forEach((header, index) => {
        let asc = true; // Default to ascending sort
        header.addEventListener('click', function() {
            sortTable(index, asc);
            asc = !asc; // Toggle direction after each click
        });
    });
});

// Update function for creating submission month
function updateCreateAgenda() {
    const selectedMonth = document.getElementById('month-create').value;
    const url = `/calendarsubcreate_view/?month=${selectedMonth}`;
    window.location.href = url;
}

function getStatusIcon(status) {
    switch (status) {
        case 'valide':
            return '<i class="fas fa-check-circle" style="color: green;"></i>';
        case 'en_cours':
            return '<i class="fas fa-clock" style="color: orange;"></i>';
        case 'refuse':
            return '<i class="fas fa-times-circle" style="color: red;"></i>';
        case 'envoye':
            return '<i class="fas fa-paper-plane" style="color: blue;"></i>';
        default:
            return '';
    }
}

function filterSubmissions() {
    const selectedStatus = document.querySelector('input[name="status-filter"]:checked').value;
    const selectedTypes = Array.from(document.querySelectorAll('input[name="type-filter"]:checked')).map(input => input.value);
    const rows = document.querySelectorAll('#submissioncreate-list tr');

    rows.forEach(row => {
        const statusCell = row.querySelector('td:last-child');
        const typeCell = row.children[1];

        let shouldDisplay = true;

        // Check status condition
        if (selectedStatus !== 'all' && statusCell) {
            shouldDisplay = statusCell.innerText.includes(selectedStatus);
        }

        // Check type condition
        if (shouldDisplay && selectedTypes.length > 0 && typeCell) {
            shouldDisplay = selectedTypes.includes(typeCell.innerText);
        }

        row.style.display = shouldDisplay ? '' : 'none';
    });
}

// Fetch submissions based on creation date
function getSubmissionsCreate(day) {
    const month = document.getElementById('month-create').value;
    fetch(`/get_submissions_for_created_at/${day}/?month=${month}`)
        .then(response => response.json())
        .then(data => {
            const submissionList = document.getElementById('submissioncreate-list');
            const baseUrl = submissionList.dataset.detailUrl.replace(/0\/$/, '');
            submissionList.innerHTML = '';

            // Clear previously selected date
            const allDayButtons = document.querySelectorAll('.daycreate-btn');
            allDayButtons.forEach(button => button.classList.remove('selected'));

            // Highlight the selected date button
            const selectedButton = document.querySelector(`.daycreate-btn[data-day='${day}']`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }

            if (data.submission && data.submission.length > 0) {
                data.submission.forEach(submission => {
                    const row = document.createElement('tr');
                    row.classList.add('clickable-row');
                    row.classList.add(`status-${submission.status}`);
                    row.dataset.href = `${baseUrl}/${submission.id}/`;

                    const createdAt = new Date(submission.created_at).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
                    const date = new Date(submission.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });

                    row.innerHTML = `
                        <td>${submission.company_name || 'N/A'}</td>
                        <td>${submission.submission_type || 'N/A'}</td>
                        <td>${submission.user__username || 'N/A'}</td>
                        <td>${createdAt}</td>
                        <td>${date}</td>
                        <td>${getStatusIcon(submission.status)} ${submission.status}</td>
                    `;
                    row.addEventListener('click', function() {
                        window.location.href = this.dataset.href;
                    });
                    submissionList.appendChild(row);
                });
            } else {
                submissionList.innerHTML = `
                    <tr>
                        <td colspan="6">Aucune soumission créée à ce jour.</td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching creation submissions:', error);
        });
}

// Theme toggle
const toggleBtn = document.getElementById('theme-toggle');
toggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
});

// Sidebar toggle
document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const btnShowSidebar = document.getElementById('show-sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    const checklistss = document.getElementById('checklistss');

    toggleBtn.addEventListener('click', () => {
        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            btnShowSidebar.style.display = 'none';
            checklistss.classList.remove('full-width');
        } else {
            sidebar.classList.add('collapsed');
            btnShowSidebar.style.display = 'block';
            checklistss.classList.add('full-width');
        }
    });

    btnShowSidebar.addEventListener('click', () => {
        sidebar.classList.remove('collapsed');
        btnShowSidebar.style.display = 'none';
        checklistss.classList.remove('full-width');
    });
});

// Fonction de tri pour le tableau de notifications
let sortDirection = {};

function sortNotificationTable(columnIndex) {
    const table = document.getElementById('notificationTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Déterminer la direction du tri
    const currentDirection = sortDirection[columnIndex] || 'asc';
    const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
    sortDirection[columnIndex] = newDirection;
    
    // Trier les lignes
    const sortedRows = rows.sort((a, b) => {
        let aValue, bValue;
        
        // Pour les colonnes avec data-sort, utiliser cette valeur
        const aCell = a.children[columnIndex];
        const bCell = b.children[columnIndex];
        
        if (aCell.dataset.sort) {
            aValue = aCell.dataset.sort;
            bValue = bCell.dataset.sort;
        } else {
            aValue = aCell.textContent.trim();
            bValue = bCell.textContent.trim();
        }
        
        // Gérer les nombres
        if (columnIndex === 2) { // Colonne "Nb personnes"
            aValue = parseInt(aValue) || 0;
            bValue = parseInt(bValue) || 0;
        }
        
        // Comparer
        if (aValue < bValue) {
            return newDirection === 'asc' ? -1 : 1;
        }
        if (aValue > bValue) {
            return newDirection === 'asc' ? 1 : -1;
        }
        return 0;
    });
    
    // Réorganiser le tableau
    tbody.innerHTML = '';
    sortedRows.forEach(row => tbody.appendChild(row));
    
    // Mettre à jour l'icône de tri
    const headers = table.querySelectorAll('thead th');
    headers.forEach((header, index) => {
        const icon = header.querySelector('i.fas');
        if (icon && (icon.classList.contains('fa-sort') || icon.classList.contains('fa-sort-up') || icon.classList.contains('fa-sort-down'))) {
            if (index === columnIndex) {
                icon.className = newDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
    });
}

// Fonction pour afficher/masquer les notifications
function toggleNotifications() {
    const content = document.getElementById('notificationContent');
    const btn = document.getElementById('toggleNotifBtn');
    const icon = document.getElementById('toggleIcon');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-chevron-up" id="toggleIcon"></i> Masquer les notifications';
        
        // Animation d'entrée
        content.style.opacity = '0';
        setTimeout(() => {
            content.style.opacity = '1';
        }, 10);
    } else {
        content.style.opacity = '0';
        setTimeout(() => {
            content.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-chevron-down" id="toggleIcon"></i> Afficher les notifications';
        }, 300);
    }
}

// Auto-ouvrir les notifications si il y a des urgentes
document.addEventListener('DOMContentLoaded', function() {
    {% if notifications_urgentes.exists %}
    // Si il y a des notifications urgentes, les afficher automatiquement
    setTimeout(function() {
        toggleNotifications();
    }, 500);
    {% endif %}
});
</script>
{% endblock %}